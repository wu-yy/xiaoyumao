!function(){BDWM.init("#page-authenticate",function(){setTimeout(function(){$('input[name="code"]').focus()},10),$('[data-action="auth-logout"]').click(function(){return $.post("./ajax/logout.php",{},function(t){t.success&&(location.href="home.php")}),!1})})}(),function(){function t(){i=!1}function e(){$("#ban-list .list-item").each(function(){n($(this))})}function a(){var t=$('.editor[data-type="new"]'),e=t.data("username");e&&t.find('[data-role="ban-username"]').val(e).attr("disabled","disabled")}function n(t){function e(){c.find('[data-action="ban-mode"]').unbind("click").click(function(){c.find(".menu").css({top:$(this).position().top+20,left:$(this).position().left+$(this).width()-c.find(".menu").width()+15}).show().focus()}),c.find(".menu").blur(function(){$(this).hide()})}function a(t){var e,a=!0,n=t.find('[data-role="ban-reason"]');n.length&&(e=n.val(),0==e.length&&(a=!1,n.parent().addClass("warning")));var i=t.find('[data-role="ban-day"]');i.length&&(e=i.val(),"unlimited"!=e&&(e=parseInt(e),(isNaN(e)||e<1||e>14)&&(a=!1,i.parent().addClass("warning"))));var o=t.find('input[data-role="ban-username"]');return o.length&&(e=o.val(),0!=e.length&&"guest"!=e||(a=!1,o.parent().addClass("warning"))),a}function o(t,e){$.ajax({type:"POST",url:"ajax/get_userinfo_by_names.php",data:{names:JSON.stringify(t)},dataType:"json",timeout:4e3}).done(function(a){if(a.success){var n="";if(_.each(a.result,function(e,a){0==e&&(n+='"'+t[a]+'"')}),n.length)e(!1);else{var i=[];_.each(a.result,function(t,e){i.push(t.id)}),e(i)}}else BDWM.alert({text:"网络错误，请稍后重试"})}).fail(function(){BDWM.alert({text:"网络错误，请稍后重试"})})}function r(t){var e=t.split(".");if(4==e.length){for(var a=0;a<4;a++){var n=parseInt(e[a]);if(isNaN(n)||n<0||n>255)return!1}return!0}return!1}function s(t){$.ajax({type:"POST",url:"ajax/set_board_denied_user.php",data:t,dataType:"json",timeout:4e3}).done(function(t){t.success?BDWM.alert({text:"封禁成功",callback:function(){BDWM.reload()},timeout:1200}):BDWM.alert({text:"封禁失败，请稍后重试"}),i=!1}).fail(function(){BDWM.alert({text:"网络错误，请稍后重试"}),i=!1})}var c=$(t);e(),c.find('[data-action="ban-mode-1"]').click(function(){var t='<input data-role="ban-day" type="number"><a data-action="ban-mode" class="mode">天<img src="images/ban/iconfont-down.png"></a>',a=$(this).parent().parent();a.children(":not(.menu)").remove(),a.prepend(t),$(this).parent().hide().children().removeClass("active"),$(this).addClass("active"),e()}),c.find('[data-action="ban-mode-2"]').click(function(){var t='<input data-role="ban-day" type="hidden" value="unlimited"><a data-action="ban-mode" class="mode">手动解封<img src="images/ban/iconfont-down.png"></a>',a=$(this).parent().parent();a.children(":not(.menu)").remove(),a.prepend(t),$(this).parent().hide().children().removeClass("active"),$(this).addClass("active"),e()}),c.find('[data-action="ban-modify"]').click(function(){var t=c.find('[data-role="ban-username"]').text(),e=c.data("ban-uid"),a=c.find('[data-role="ban-reason"]').text(),i=$($("#ban-editor-template").html());i.find('[data-role="ban-username"]').text(t),i.find('[data-role="ban-reason"]').val(a),i.data("ban-uid",e),i.appendTo("#ban-list"),i.css({top:c.position().top,left:c.position().left,background:c.css("background"),width:c.width()}),n(i)}),c.find('[data-action="ban-modify-cancel"]').click(function(){c.remove()}),c.find('[data-action="ban-modify-sure"]').click(function(){if(0!=a(c)){var t=c.data("bid"),e=c.find('[data-role="ban-reason"]').val(),n=c.find('[data-role="ban-day"]').val();n="unlimited"==n?0:parseInt(n);var o,s=c.data("ban-uid"),d=c.find('[data-role="ban-username"]').text();o=r(d.toString())?{action:"add",ip:d,day:n,bid:t,reason:e}:{action:"add",uid:s,day:n,bid:t,reason:e},i||(i=!0,$.ajax({type:"POST",url:"ajax/set_board_denied_user.php",data:o,dataType:"json",timeout:4e3}).done(function(t){t.success?BDWM.alert({text:"修改成功",callback:function(){c.remove(),BDWM.reload()},timeout:1200}):BDWM.alert({text:"修改失败，请稍后重试"}),i=!1}).fail(function(){BDWM.alert({text:"网络错误，请稍后重试"}),i=!1}))}}),c.find('[data-action="ban-delete"]').click(function(){var t,e=c.data("bid"),a=c.data("ban-uid"),n=c.find('[data-role="ban-username"]').text();t=r(n.toString())?{action:"delete",ip:n,bid:e}:{action:"delete",uid:a,bid:e},i||(i=!0,$.ajax({type:"POST",url:"ajax/set_board_denied_user.php",data:t,dataType:"json",timeout:4e3}).done(function(t){t.success?BDWM.alert({text:"解封成功",callback:function(){BDWM.reload()},timeout:1200}):BDWM.alert({text:"解封失败，请稍后重试"}),i=!1}).fail(function(){BDWM.alert({text:"网络错误，请稍后重试"}),i=!1}))}),c.find('[data-action="ban-submit"]').click(function(){if(0!=a(c)){var t="",e=c.data("bid"),n=c.find('[data-role="ban-reason"]').val(),d=c.find('[data-role="ban-day"]').val();d="unlimited"==d?0:parseInt(d);var l=c.find('[data-role="ban-username"]').val();if("anonymous"==l.toLowerCase()&&(t=c.data("postid")),!i){i=!0;var u;r(l)?(u={action:"add",ip:l,day:d,bid:e,reason:n},BDWM.confirm({title:"是否立即对 "+l+" 实施禁言？",callback:function(t){t?s(u):i=!1}})):"anonymous"==l.toLowerCase()?(u={action:"add_anony",day:d,bid:e,reason:n,postid:t},BDWM.confirm({title:"是否立即对 "+l+" 实施禁言？",callback:function(t){t?s(u):i=!1}})):o([l],function(t){if(0==t)return c.find('input[data-role="ban-username"]').parent().addClass("warning"),void(i=!1);var a={action:"add",uid:t[0],day:d,bid:e,reason:n};BDWM.confirm({title:"是否立即对 "+l+" 实施禁言？",callback:function(t){t?s(a):i=!1}})})}}})}BDWM.init("#page-thread #ban",function(){t(),a(),e()});var i}(),function(){function t(){return parseInt($("#board-head").data("bid"))}function e(t){$("#page-collection").length>0?n(t):a(t)}function a(e){var a=e.find(".search-box"),n=t();BDWM.searchBox(a,{name:"board-head-search",placeholder:"版面内搜索",confirm:function(t){var e="search.php?days=24855&bid="+n+"&key="+t;BDWM.redirect(e)},tips:{url:"ajax/get_post_by_num.php",generateRequestParams:function(t){return{bid:n,num:parseInt(t)}},getItemsFromData:function(t,e){var a=[];if(t.success&&t.list.length>0){var i=t.list[0];a.push({str:i.title,url:"post-read-single.php?bid="+n+"&postid="+i.postid,text:e+"："+i.title})}var o=/^[A-Za-z]*$/;return o.test(e)&&a.push({str:e,url:"search.php?days=24855&bid="+n+"&owner="+e,text:"用户"+e+"的帖子"}),a.push({str:e,url:"search.php?days=24855&bid="+n+"&key="+e,text:"搜索标题包含"+e+"的帖子"}),a},modifyViewFromItem:!1,confirm:function(t){BDWM.redirect(t.url)}},history:!1})}function n(e){var a=e.find(".search-box"),n=t();BDWM.searchBox(a,{name:"board-head-search",placeholder:"精华区内搜索",confirm:function(t){var e="search.php?mode=collection&bid="+n+"&key="+t;BDWM.redirect(e)},tips:{url:!1,getItemsFromData:function(t,e){var a=[];return a.push({str:e,url:"search.php?mode=collection&bid="+n+"&key="+e,text:"搜索标题包含"+e+"的精华区内容"}),a},modifyViewFromItem:!1,confirm:function(t){BDWM.redirect(t.url)}},history:!1})}BDWM.init("#board-head",function(){e($("#board-head"))})}.call(this),function(){function t(){u=0,f=!1}function e(){$('.section[data-show-mode="list"]').each(function(){$(this).find('[data-action="show-list"]').addClass("active"),$(this).find(".boards-wrapper.blocks").hide(),$(this).removeAttr("data-show-mode")}),$('.section[data-show-mode="blocks"]').each(function(){$(this).find('[data-action="show-blocks"]').addClass("active"),$(this).find(".boards-wrapper.list").hide(),$(this).removeAttr("data-show-mode")}),$('[data-fold="close"]').each(function(){$(this).find('[data-action="hide-section"]').hide(),$(this).find(".section-content").hide(),$(this).removeAttr("data-fold")}),$('[data-fold="open"]').each(function(){$(this).find('[data-action="show-section"]').hide(),$(this).removeAttr("data-fold")})}function a(){$("[data-action='show-section']").click(function(t){var e=$(this).closest(".section,.sub-section");e.find(".section-content").slideDown(),$(this).hide(),e.find("[data-action='hide-section']").show(),t.stopPropagation()}),$("[data-action='hide-section']").click(function(t){var e=$(this).closest(".section,.sub-section");e.find(".section-content").slideUp(),$(this).hide(),e.find("[data-action='show-section']").show(),t.stopPropagation()}),$('[data-action="whole-click"]').css({cursor:"pointer"}).click(function(){$(this).find(".button[data-action]").each(function(){if("none"!=$(this).css("display"))return $(this).click(),!1})})}function n(){$("[data-action='show-blocks']").click(function(){var t=$(this).closest(".section");t.find(".boards-wrapper.list").hide(),t.find(".boards-wrapper.blocks").show(),$(this).addClass("active"),t.find("[data-action='show-list']").removeClass("active")}),$("[data-action='show-list']").click(function(){var t=$(this).closest(".section");t.find(".boards-wrapper.blocks").hide(),t.find(".boards-wrapper.list").show(),$(this).addClass("active"),t.find("[data-action='show-blocks']").removeClass("active")})}function i(){$("[data-action='show-hide-sub-blocks']").each(function(){var t=0,e=[function(){var t=$(this).closest(".board-block"),e=t.nextUntil(".board-block:not(.sub-block)");l(e,!0),$(this).find(".spread-right").hide(),$(this).find(".withdraw-left").show()},function(){var t=$(this).closest(".board-block"),e=t.nextUntil(".board-block:not(.sub-block)");l(e,!1),$(this).find(".withdraw-left").hide(),$(this).find(".spread-right").show()}];$(this).click(function(a){a.stopPropagation(),a.preventDefault(),0==u&&(e[t].bind(this).call(this),t=(t+1)%2)})})}function o(){$(".boards-wrapper.blocks").each(function(){var t=$(this).find(".board-block");t.size()&&t.parent().hasClass("set")&&$(this).append(t.remove())}),c()}function r(){$("[data-action='make-favorite']").click(function(t){if(t.stopPropagation(),t.preventDefault(),!f){var e=this;$(this).hasClass("active")?s($(this).closest(".board-block").attr("data-bid"),!1).done(function(t){t.success&&$(e).removeClass("active")}):(f=!0,s($(this).closest(".board-block").attr("data-bid"),!0).done(function(t){t.success&&($("#favorite-modal").bdwm_dialog().show(),$(e).addClass("active"),setTimeout(function(){f=!1},2e3))}))}})}function s(t,e){return $.ajax({type:"POST",url:"ajax/set_good_boards.php",data:{action:e?"add":"delete",bids:JSON.stringify([parseInt(t)])},dataType:"json"})}function c(){var t=150,e=350;$(".boards-wrapper.blocks").each(function(){var a=$(this).find(".board-block:not(.hidden)");a.each(function(a){$(this).css({position:"absolute",left:e*(a%3),top:t*Math.floor(a/3)})});var n=a.size(),i=t*Math.ceil(n/3);parseInt($(this).height())>i?$(this).animate({height:i}):$(this).css({height:i})})}function d(){var t=["red","cyan","yellow","blue"];$(".boards-wrapper.blocks").each(function(){$(this).find(".board-block:not(.sub-block)").each(function(e){$(this).addClass(t[e%4])})})}function l(t,e){u+=t.size(),e?(t.removeClass("hidden"),c(),t.each(function(t){$(this).css({left:parseInt($(this).css("left"))-30,opacity:0,"-moz-opacity":0,filter:"alpha(opacity=0)"}),$(this).addClass("animating"),setTimeout(function(){$(this).css({left:parseInt($(this).css("left"))+30,opacity:1,"-moz-opacity":1,filter:"alpha(opacity=100)"}),setTimeout(function(){u--,$(this).removeClass("animating")}.bind(this),300)}.bind(this),400+200*t)})):(t.each(function(t){$(this).addClass("animating"),$(this).css({left:parseInt($(this).css("left"))-30,opacity:0,"-moz-opacity":0,filter:"alpha(opacity=0)"})}),setTimeout(function(){t.addClass("hidden").removeClass("animating"),c()},300),setTimeout(function(){u=0},650))}BDWM.init("#page-board",function(){t(),d(),o(),e(),a(),n(),i(),r()}.bind(this));var u=0,f=!1}.call(this),function(){function t(t,e,a,n){n||(n=BDWM.reload),$.post(t,e,function(t){"success"in t?t.success?a?BDWM.alert({text:a+"成功",callback:n,timeout:2e3}):n():BDWM.alert({text:(a||"操作")+"失败，请稍后重试"}):t.results.every(function(t){return t===!1})?a?BDWM.alert({text:a+"成功",callback:n,timeout:2e3}):n():BDWM.alert({text:(a||"操作")+"未完全成功，请稍后重试"})}).fail(function(){BDWM.alert({text:"网络错误，请稍后重试"})})}function e(){r=$("#page-collection-read").data("path"),$(".toolbox .delete").click(function(){BDWM.confirm({text:"确实要删除该文件吗？",callback:function(e){e&&t("ajax/operate_collection.php",{action:"delete",path:r},"删除",function(){history.back(),setTimeout(BDWM.reload,1e3)})}})}),$(".toolbox .archive").click(function(){var e=new BDWM.CollectionRelatedOp("收集到",function(e){t("ajax/operate_collection.php",{action:"copy",tobase:e,path:r},"收入文集")});e.show()})}function a(){c=!1,l=$(".bdwm-editor").data("mode")}function n(){if(d=$("#new-collection-file-textarea").bdwm_editor({})[0],$('[data-action="new-collection-file-publish"]').click(i),s=new BDWM.FileUploader({dir:$('[data-action="file-upload"]').data("upload-dir"),action:"ajax/upload.php",onSubmit:function(t,e){console.log("id="+t+" ,filename="+e+". onSubmit!")},onComplete:function(t,e,a){console.log(a),console.log("id="+t+" ,filename="+e+". onComplete!"),c=!0}}).trigger($('[data-action="file-upload"]')),"modify"==l){var t=$("#collection-origin");!t||0==t.length||0==t.text().length&&0==t.find("img").length?(t="<p><br></p>",d.inject(t)):(d.injectObject(t),t.remove());var e=$('[data-action="file-upload"]').data("file-list");e.length>0&&(c=!0),_.each(e,function(t){s.insertFileListItem(null,t,t)})}}function i(){var t=$('[data-role="collection-title"]').val();if(0==t.length)return void BDWM.alert({text:"标题不可为空"});var e=d.toStruct();if(0==e.length)return void BDWM.alert({text:"内容不可为空"});var a={title:t,content:JSON.stringify(e),mode:l,attachpath:c?$('[data-action="file-upload"]').data("upload-dir"):""};"new"==l?a.base=$(".bdwm-editor").data("base"):"modify"==l&&(a.path=$(".bdwm-editor").data("path")),$.ajax({type:"POST",url:"new"==l?"ajax/create_collection_file.php":"ajax/edit_collection_file.php",data:a,dataType:"json",timeout:4e3}).done(function(t){t.success?(BDWM.alert({text:"操作成功!"}),setTimeout(function(){history.back(1),setTimeout(function(){BDWM.reload()},500)},1200)):BDWM.alert({text:"创建/修改精华区文件失败"})}).fail(function(){BDWM.alert({text:"网络错误，请稍后重试"})})}function o(){var t=function(e,a,n){$(e).contents().each(function(){3==this.nodeType?this.nodeValue=this.nodeValue.replace(new RegExp(a,"g"),n):t(this,a,n)})},e=$(".content"),a=e.find(".file-read:not(.signature)");a.find("p.code").length>0?e.find('[data-action="ascii-toggle"]').hide():e.find('[data-action="ascii-toggle"]').click(function(){var e=$(this);if(e.hasClass("active"))e.removeClass("active"),a.removeClass("pre"),a.html(a.attr("data-ascii-mode-origin"));else{e.addClass("active");var n=a.html();a.attr("data-ascii-mode-origin",n),a.addClass("pre"),t(a,"\\s"," ")}})}BDWM.init("#page-collection-new",function(){a(),n()}),BDWM.init("#page-collection-read",function(){o(),e()});var r,s,c,d,l}(),function(t,e){function a(e,a,n){t.post(e,a,function(t){"success"in t?t.success?n?BDWM.alert({text:n+"成功",callback:BDWM.reload,timeout:2e3}):BDWM.reload():BDWM.alert({text:(n||"操作")+"失败，请稍后重试"}):t.results.every(function(t){return t===!1})?n?BDWM.alert({text:n+"成功",callback:BDWM.reload,timeout:2e3}):BDWM.reload():BDWM.alert({text:(n||"操作")+"未完全成功，请稍后重试"})}).fail(function(){BDWM.alert({text:"网络错误，请稍后重试"})})}function n(e){return t(".item-checkbox input[type=checkbox]:checked").each(function(){e&&t(this).closest(".collection-item").each(e)})}function i(t){return t.find(".item-name:not(.rename)").text().trim()}function o(e){return function(){e.placement=e.placement||"bottom";var a=t(this),n=a.offset();n.left+=a.width()/2,"bottom"==e.placement?n.top+=a.height()+20:n.top-=20;var i=BDWM.confirm({text:e.html.replace(/\$([^\$]+)\$/g,function(t,a){return e[a]()}).replace(/#([^#]+)#/g,function(t,e){return e.indexOf("num")!=-1?'<input type="number" id="'+e+'" style="width: 100px" min="1" class="generic-input-box" />':'<input type="text" id="'+e+'" style="width: 100px" class="generic-input-box" />'}),callback:e.callback}),o=i.confirm.offset();o.left+=i.confirm.width()/2,"bottom"!=e.placement&&(o.top+=i.confirm.height()),"center"!=e.placement&&i.confirm.css({transform:"translate("+(n.left-o.left)+"px, "+(n.top-o.top)+"px)"})}}function r(){b.currentPath=t("#page-collection").data("path"),b.total=t("#page-collection").data("total")}function s(){var n=h.addClass("sorting");g=Sortable.create(n[0],{group:{name:"collection",pull:!0,put:!1},animation:150,scroll:!0,scrollSensitivity:60,scrollSpeed:10,onStart:function(){p=g.toArray()},onEnd:function(n){if(n.newIndex!==e){var i=t(n.item);if(i.parent().is(n.from)){var o=p[n.newIndex];h.addClass("disabled"),a("ajax/operate_collection.php",{action:"movepos",path:[b.currentPath,i.data("name")].join("/"),pos:o-1})}}}}),f=p=g.toArray()}function c(){b.isBoardCollection=!0,t("#tab-button-collection").addClass("active"),t("#favorite-modal").hide(),t("#search-box").prop("placeholder","精华区内搜索(施工中)")}function d(){h=t(".collection-list:not(.drop-area)"),$=Sortable.create((m=t(".collection-list.drop-area"))[0],{group:{name:"collection",pull:!1,put:!0},sort:!1,onAdd:function(e){var n=t(e.item);o({html:"将 $fileName$ 移动到：<br />第 #move_numTargetPos# / $totalPages$ 位置",placement:"top",fileName:function(){return i(n)},totalPages:function(){return b.total},callback:function(e){e?(n.hide(),h.addClass("disabled"),a("ajax/operate_collection.php",{action:"movepos",path:[b.currentPath,n.data("name")].join("/"),pos:t("#move_numTargetPos").val()-1})):(h.append(n),g.sort(p))}}).call(e.item)}})}function l(){t(".check-all input").change(function(){t(".item-checkbox input[type=checkbox]").prop("checked",this.checked)}),t(".item-checkbox input[type=checkbox]").change(function(){this.checked||t(".check-all input").prop("checked",!1)}),t(".show-while-sorting.buttons > button").click(function(){t(this);b.isSorting=!1,g.destroy(),h.removeClass("sorting").find(".collection-item").show(),t(".show-while-sorting").fadeOut().promise().done(function(){t(".hide-while-sorting").fadeIn()})}),t(".collection-item .item-name.rename > a").click(function(){var e=t(this);e.hasClass("negative")||a("ajax/operate_collection.php",{action:"edit_title",path:[b.currentPath,v.data("name")].join("/"),title:v.find(".item-name.rename input").val(),bms:v.find(".item-author span").text()},"重命名"),v.removeClass("renaming"),v=null}),t(".collection-item .item-actions .rename").click(function(){var e=t(this);v&&v.removeClass("renaming"),v=e.closest(".collection-item").addClass("renaming"),v.find(".item-name.rename input").val(i(v))}),t(".collection-item .item-actions .delete").click(function(){var e=t(this).closest(".collection-item");BDWM.confirm({text:'确定要删除<span style="margin: 0 0.5em; color: #e97c62">'+i(e)+"</span>吗？",callback:function(t){t&&a("ajax/operate_collection.php",{action:"delete",path:[b.currentPath,e.data("name")].join("/")},"删除")}})}),t(".collection-item .item-actions .move").click(function(){var e=t(this).closest(".collection-item");BDWM.confirm({text:'确定要移动<span style="margin: 0 0.5em; color: #e97c62">'+i(e)+"</span>吗？",callback:function(t){if(t){var n=new BDWM.CollectionRelatedOp("移动到",function(t){a("ajax/operate_collection.php",{action:"move",tobase:t,path:[b.currentPath,e.data("name")].join("/")},"移动")});n.show()}}})}),t(".collection-item .item-actions .add-fav").click(function(){var e=t(this).closest(".collection-item");"dir"==e.data("type")&&a("ajax/set_good_collections.php",{action:"add",paths:JSON.stringify([[b.currentPath,e.data("name")].join("/")])},"收藏")}),t(".collection-item .item-actions .archive").click(function(){var e=t(this).closest(".collection-item");if("file"==e.data("type")){var n=new BDWM.CollectionRelatedOp("收录到",function(t){a("ajax/operate_collection.php",{action:"copy",tobase:t,path:[b.currentPath,e.data("name")].join("/")},"收入文集")});n.show()}});for(var e in w)w[e]instanceof Function?t(".toolbar ."+e).click(w[e]):t(".toolbar ."+e).click(o(w[e]))}function u(t){if(!t.hasClass("board-collection")){var e=t.find(".main-block .search-wrapper"),a=t.data("uid");BDWM.searchBox(e,{name:"board-head-search",placeholder:"文集内搜索",confirm:function(t){var e="search.php?mode=corpus&uid="+a+"&key="+t;BDWM.redirect(e)},tips:{url:!1,getItemsFromData:function(t,e){var n=[];return n.push({str:e,url:"search.php?mode=corpus&uid="+a+"&key="+e,text:"搜索"+e+"相关文集标题"}),n},modifyViewFromItem:!1,confirm:function(t){BDWM.redirect(t.url)}},history:!1})}}BDWM.init("#page-collection",function(){r(),t("#page-collection").hasClass("board-collection")&&c(),d(),l(),b.isSorting&&(t(".hide-while-sorting").hide(),t(".show-while-sorting").show(),s()),u(t("#page-collection"))}),jQuery.fn.serializeObject=function(){var a={},n=this.serializeArray();return t.each(n,function(){a[this.name]!==e?(a[this.name].push||(a[this.name]=[a[this.name]]),a[this.name].push(this.value||"")):a[this.name]=this.value||""}),a};var f,p,h,m,v=null,g=null,$=null,b={currentPath:"",isBoardCollection:!1,isSorting:!1,total:0},w={archive:{html:'被勾选的项目中，只有文件可以被收入文集。<br />是否要将这<span style="margin: 0 0.5em; color: #e97c62">$selectedFilesCount$</span>个文件收入文集？',callback:function(e){if(e){var i=[];n(function(){var e=t(this);"file"==e.data("type")&&i.push([b.currentPath,e.data("name")].join("/")),"link_file"==e.data("type")&&i.push(e.data("name"))});var o=new BDWM.CollectionRelatedOp("收录到",function(t){a("ajax/operate_collection_batched.php",{action:"copy",tobase:t,list:i},"收入文集")});o.show()}},selectedFilesCount:function(){var e=0;return n(function(){var a=t(this);a.data("type")in{file:!0,link_file:!0}&&e++}),e}},move:{html:'是否要移动这<span style="margin: 0 0.5em; color: #e97c62">$selectedCount$</span>个项目？',callback:function(e){if(e){var i=[];n(function(){var e=t(this);i.push([b.currentPath,e.data("name")].join("/"))});var o=new BDWM.CollectionRelatedOp("移动到",function(t){a("ajax/operate_collection_batched.php",{action:"move",tobase:t,list:i},"移动")});o.show()}},selectedCount:function(){return n().length}},"delete":{html:'是否删除选中的<span style="margin: 0 0.5em; color: #e97c62">$selectedCount$</span>个项目？',callback:function(e){if(e){var i=[];n(function(){i.push([b.currentPath,t(this).data("name")].join("/"))}),a("ajax/operate_collection_batched.php",{action:"delete",list:i},"删除")}},selectedCount:function(){return n().length}},sort:function(){b.isSorting=!0,t(".hide-while-sorting").fadeOut().promise().done(function(){t(".show-while-sorting").fadeIn(),s()})},"add-fav":{html:'是否将选中的<span style="margin: 0 0.5em; color: #e97c62">$selectedFolderCount$</span>个目录加入精华区 / 文集收藏夹中？',callback:function(e){if(e){var i=[];n(function(){var e=t(this);"dir"==e.data("type")?i.push([b.currentPath,e.data("name")].join("/")):"link_dir"==e.data("type")&&i.push(e.data("name"))}),a("ajax/set_good_collections.php",{paths:JSON.stringify(i),action:"add"},"收藏")}},selectedFolderCount:function(){var e=0;return n(function(){var a=t(this);a.data("type")in{dir:!0,link_dir:!0}&&e++}),e}},"add-dir":{html:"文件夹名称：#add_dirName#<br />整理者：#add_bms#",callback:function(e){if(e){var n={base:b.currentPath,title:t("#add_dirName").val(),bms:t("#add_bms").val()};return n.title?void a("ajax/create_collection_dir.php",n,"创建"):t("#add_dirName").addClass("warning")}}}}}(jQuery),window.test=0,function(){function t(){f="ajax/set_good_collections.php",p=[],h=[],m=[],v=0}function e(){$("#favorites-list .favorite-block").each(function(){p[v]={id:v,path:$(this).attr("data-path"),name:$(this).find(".name").text(),engName:$(this).find(".eng-name").text()},v++})}function a(){$('.bdwm-dialog [data-action="dismiss"]').click(function(){u("edit-favorites-modal"),u("clear-unread-modal")}),$('#edit-favorites-modal [data-action="submit"]').click(c)}function n(){$('[data-action="show-clear-unread-modal"]').click(function(t){t.preventDefault(),l("clear-unread-modal")}),$('[data-action="show-edit-modal"]').click(function(t){t.preventDefault(),i(),l("edit-favorites-modal")})}function i(){m=[],h=_.pluck(p,"id"),$("#edit-favorites-modal .favorites-wrapper").children().remove();var t='<div class="favorite-block" data-bid="__%id%__"><div class="eng-name">__%engName%__</div><div class="name">__%name%__</div><a class="cancel" data-action="remove-block"><i class="icon-font">&#xe63c;</i></a></div>';_.each(p,function(e){$("#edit-favorites-modal .favorites-wrapper").append(t.replace("__%id%__",e.id).replace("__%engName%__",e.engName).replace("__%name%__",e.name))}),$('#edit-favorites-modal [data-action="remove-block"]').unbind("click").click(function(t){t.stopPropagation();var e=$(this).closest(".favorite-block");m.push(parseInt(e.attr("data-bid"))),e.remove(),$("#edit-favorites-modal .favorites-wrapper").gridly("layout")}),o()}function o(){$("#edit-favorites-modal .favorites-wrapper").gridly({base:30,gutter:15,columns:12,callbacks:{reordered:s}})}function r(){$(".favorite-block .update").click(function(){$(this).closest(".favorite-block").find(".block-link")[0].click()})}function s(t){h=[],t.each(function(){h.push(parseInt($(this).attr("data-bid")))})}function c(){var t=$('#edit-favorites-modal [data-action="submit"]');if("disabled"!=t.attr("disabled")){t.attr("disabled","disabled"),t.find(".icon-font").html("&#xe686;");var e=_.difference(h,m),a=[];return _.each(e,function(t){return a.push(p[t].path)}),d(a).done(function(e){e.success?(u("edit-favorites-modal"),$.pjax.reload("#page-content")):(t.removeAttr("disabled"),t.find(".icon-font").html("&#xe61d;"))}).fail(function(){t.removeAttr("disabled"),t.find(".icon-font").html("&#xe61d;")})}}function d(t){return $.ajax({type:"POST",url:f,data:{paths:JSON.stringify(t),action:"set"},dataType:"json"})}function l(t){$("#"+t).bdwm_dialog().show()}function u(t){$("#"+t).bdwm_dialog().hide()}BDWM.init("#page-favorite-collection",function(){t(),e(),a(),n(),r()}.bind(this));var f="ajax/set_good_collections.php",p=[],h=[],m=[],v=0}.call(this),function(){function t(){h="ajax/set_board_read.php",m="ajax/set_good_boards.php",v=[],g=[],b=[]}function e(){$("#favorites-list .favorite-block").each(function(){v.push({id:parseInt($(this).attr("data-bid")),name:$(this).find(".name").text(),engName:$(this).find(".eng-name").text()})})}function a(){$('.bdwm-dialog [data-action="dismiss"]').click(function(){p("edit-favorites-modal"),p("clear-unread-modal")}),$('#clear-unread-modal [data-action="submit"]').click(c),$('#edit-favorites-modal [data-action="submit"]').click(d)}function n(){$('[data-action="show-clear-unread-modal"]').click(function(t){t.preventDefault(),f("clear-unread-modal")}),$('[data-action="show-edit-modal"]').click(function(t){t.preventDefault(),i(),f("edit-favorites-modal")}),$('[data-action="change-mode"]').click(function(t){t.preventDefault(),BDWM.setCookie("favorite_mode",$(this).data("mode")),BDWM.reload()})}function i(){b=[],g=_.pluck(v,"id"),$("#edit-favorites-modal .favorites-wrapper").children().remove();var t='<div class="favorite-block" data-bid="__%id%__"><div class="eng-name">__%engName%__</div><div class="name">__%name%__</div><a class="cancel" data-action="remove-block"><i class="icon-font">&#xe63c;</i></a></div>';_.each(v,function(e){$("#edit-favorites-modal .favorites-wrapper").append(t.replace("__%id%__",e.id).replace("__%engName%__",e.engName).replace("__%name%__",e.name))}),$('#edit-favorites-modal [data-action="remove-block"]').unbind("click").click(function(t){t.stopPropagation();var e=$(this).closest(".favorite-block");b.push(parseInt(e.attr("data-bid"))),e.remove(),$("#edit-favorites-modal .favorites-wrapper").gridly("layout")}),r()}function o(){}function r(){$("#edit-favorites-modal .favorites-wrapper").gridly({base:30,gutter:15,columns:12,callbacks:{reordered:s}})}function s(t){g=[],t.each(function(){g.push(parseInt($(this).attr("data-bid")))})}function c(){return $("#favorites-list").find("b").remove(),$("#favorites-list").find(".dot.red").removeClass("red"),p("clear-unread-modal"),l(_.pluck(v,"id")).done(function(t){}).fail(function(){})}function d(){var t=$('#edit-favorites-modal [data-action="submit"]');if("disabled"!=t.attr("disabled"))return t.attr("disabled","disabled"),t.find(".icon-font").html("&#xe61f;"),u(_.difference(g,b)).done(function(e){e.success?(p("edit-favorites-modal"),$.pjax.reload("#page-content")):(t.removeAttr("disabled"),t.find(".icon-font").html("&#xe61d;"))}).fail(function(){t.removeAttr("disabled"),t.find(".icon-font").html("&#xe61d;")})}function l(t){return $.ajax({type:"POST",url:h,data:{bids:JSON.stringify(t)},dataType:"json"})}function u(t){return $.ajax({type:"POST",url:m,data:{bids:JSON.stringify(t),action:"set"},dataType:"json"})}function f(t){$("#"+t).bdwm_dialog().show()}function p(t){$("#"+t).bdwm_dialog().hide()}BDWM.init("#page-favorite",function(){t(),e(),a(),n(),o()}.bind(this));var h="ajax/set_board_read.php",m="ajax/set_good_boards.php",v=[],g=[],b=[]}.call(this),function(){function t(){}function e(){}function a(){$("body").click(function(t){$("#page-friend .operations").hide()})}function n(){$('.friend-card [data-action="show-operation-list"]').click(function(t){t.stopPropagation(),$("#page-friend .operations").hide(),$(this).closest(".friend-card").find(">.operations").show()})}function i(){$('.friend-card [data-action="show-setting-list"]').click(function(t){t.stopPropagation(),$("#page-friend .operations").hide(),$(this).closest(".functions").find(">.operations").show()})}BDWM.init("#page-friend",function(){t(),e(),n(),i(),a()})}(),function(){var frameworkLoaded=!1;$(document).ready(function(){function resetStatus(){$("#icon-mail").removeClass("clicked"),$("#icon-setting").removeClass("clicked"),$('[data-action="user-list-trigger"]').parent().removeClass("clicked"),$(".btn-list").slideUp(300),$(".mail-extend-menu").hide(100),$(".setting-extend-menu").hide(100)}if(!frameworkLoaded){frameworkLoaded=!0,function(){if(detect){var t=detect.parse(navigator.userAgent);if(window.ua=t,"mobile"==t.device.type.toLowerCase()){$("body").addClass("mobile");var e=function(){$("#left-nav").css({minHeight:$("body").height()})};$(window).resize(e),BDWM.init("",function(){e()}),e()}}}(),function(){if(detect){var t=detect.parse(navigator.userAgent);"ie"==t.browser.family.toLowerCase()&&t.browser.major<9&&(window.location="https://www.bdwm.net/bbs/index.php")}}();var adjustFooter=function(){try{var t=$("#footer"),e=$("#page-content");if(t){var a=e.offset().top+e.height()+parseInt(e.css("padding-top"))+parseInt(e.css("padding-bottom"))+t.height()+parseInt(t.css("padding-top"))+parseInt(t.css("padding-bottom"));a<$(window).height()?t.css({position:"absolute",bottom:"0",width:$(window).width()-parseInt(t.css("margin-left"))}):t.css({position:"",bottom:"",width:""})}}catch(n){}};if(function(){adjustFooter(),$(window).resize(adjustFooter),$("#page-content").resize(adjustFooter)}(),function(){var $topNav=$("#top-nav"),$leftNav=$("#left-nav"),$ele=$topNav.find(".search-box"),mask=$(".mask-without-header");BDWM.searchBox($ele,{name:"top-search",confirm:function(t){var e="search.php?mode=post&key="+t;BDWM.redirect(e)},tips:{url:"ajax/get_topsearch.php",getItemsFromData:function(t,e){var a=[];t.success||(t.boards=[],t.users=[]);var n,i;for(a.push({str:e,url:"search.php?mode=board&key="+e,type:"category",word:"版面"}),n=_.min([t.boards.length,5]),i=0;i<n;++i)a.push(_.extend(t.boards[i],{str:t.boards[i].name,url:"thread.php?bid="+t.boards[i].id,type:"board"}));for(a.push({str:e,url:"search.php?mode=user&key="+e,type:"category",word:"用户"}),n=_.min([t.users.length,5]),i=0;i<n;++i)a.push(_.extend(t.users[i],{str:t.users[i].username,url:"user.php?uid="+t.users[i].id,type:"user"}));return a.push({str:e,url:"search.php?mode=post&key="+e,type:"category",word:"帖子"}),a},modifyViewFromItem:function(item,$li,searchedKey){$li.addClass(item.type);var html,itemOperate=function(str,key){var regExp=eval("/("+key+")/gi");return str.replace(regExp,"<strong>$1</strong>")};switch(item.type){case"category":html='搜索<strong class="keyword">'+searchedKey+"</strong>相关"+item.word,$li.html(html);break;case"board":str=item.name+" "+item.cnname,$li.html(itemOperate(str,searchedKey));break;case"user":$li.html(itemOperate(item.username,searchedKey)),item.group>=14&&$li.append($('<i class="verified-min vip-min-'+(item.group-14)+'"></i>')),$li.prepend($('<img class="portrait" src="'+item.avatar+'">'))}},confirm:function(t){BDWM.redirect(t.url)}},history:!0,focus:function(){mask.show(),$leftNav.css({"z-index":90})},blur:function(){mask.hide(),$leftNav.css({"z-index":151
    })},placeholder:"搜索版面、帖子、用户"})}(),function(){var t=!1,e=null,a=function(){if(!t){t=!0;var e="ajax/get_new_mails.php";"undefined"!=typeof login&&login&&$.ajax({url:e,type:"POST",dataType:"json",success:function(e){if(e.success){var a=$(".mail-template"),n=a.parent("div"),i=n.find(".no-mail");0==e.count?($("#icon-mail .notice-digit").hide(),0==i.length&&(i=$('<span class="no-mail">没有新的信件</span>'),n.prepend(i)),i.show()):(i.hide(),$("#icon-mail .notice-digit").show().html(e.count>99?"99+":e.count));var o=a.parent("div").find("ul");o.html("");for(var r=0;r<e.newest.length;++r){var s=e.newest[r].owner,c=e.newest[r].title,d=e.newest[r].content,l=e.newest[r].own_avatar,u="mail-read.php?postid="+e.newest[r].postid,f=a.clone();f.find(".username").text(s),f.find(".title").text(c),f.find(".detail").text(d),f.find(".wrapper").attr("href",u),f.find(".portrait").attr("src",l),f.removeClass("hidden-template"),f.removeClass("mail-template"),o.append(f)}}t=!1},error:function(){t=!1}})}},n=function(){null!=e&&clearTimeout(e),a(),e=setTimeout(n,6e4)};n(),BDWM.init("",n)}(),"undefined"!=typeof login&&login){var blockLogin=$(".have-login"),blockNotLogin=$(".not-login");blockLogin.show(),blockNotLogin.hide(),blockLogin.find(".portrait").click(function(){blockLogin.find(".btn-goto-homepage").click()})}var doLogin=function(){var t=($(".have-login"),$(".not-login"));t.addClass("logging");var e=t.find("input[name=username]"),a=t.find("input[name=password]"),n=e.val(),i=a.val();if(0==n.length)return BDWM.alert({text:"请输入用户名",callback:function(){e.focus()}}),!1;if(0==i.length)return BDWM.alert({text:"请输入密码",callback:function(){a.focus()}}),!1;var o=CryptoJS.MD5(i+n+i).toString().toLowerCase();$.post("ajax/login.php",{username:n,password:i,keepalive:$('input[name="keepalive"]').prop("checked")?1:0,t:o},function(e){if(e.success)location.reload();else{t.removeClass("logging");var a=t.find("input[name=username]"),n=t.find("input[name=password]");switch(e.error){case 4:BDWM.alert("您输入的用户名不存在"),a.val(""),n.val(""),a.focus();break;case 5:BDWM.alert("您输入的密码有误，请重新输入"),n.val(""),n.focus();break;default:BDWM.alert("其他错误发生辣>,<")}}},"json").error(function(){BDWM.alert("网络错误，请重试")})};$("#btn-login").click(doLogin),$(".not-login input[name=username],.not-login input[name=password]").on("keydown",function(t){13==t.keyCode&&doLogin()}),$(".btn-logout").click(function(){return $.post("ajax/logout.php",{},function(t){t.success&&location.reload()}),!1}),$(".page-notice>button").click(function(){$("#page-notice-container").hide()}),BDWM.init("",function(){if(!($("#page-login").length>0)&&"test"!=window.username){var t=$("#login-info");if(t&&t.length>0)if(t.find('[data-role="login-info-username"]').data("value")!=window.username)location.reload();else if("guest"!=t.find('[data-role="login-info-username"]').data("value")){$("#user-info .have-login").show(),$("#user-info .not-login").hide();var e=$("#user-info");e.find('[data-role="login-username"]').text(t.find('[data-role="login-info-username"]').data("value")),e.find('[data-role="login-nickname"]').text("昵称："+t.find('[data-role="login-info-nickname"]').data("value")),e.find('[data-role="login-rankname"]').text("等级："+t.find('[data-role="login-info-rankname"]').data("value")),e.find('[data-role="login-numposts"]').text("文章："+t.find('[data-role="login-info-numposts"]').data("value")),window.login=!0,window.username=t.find('[data-role="login-info-username"]').data("value")}else window.login=!1,window.username="guest",$("#user-info .have-login").hide(),$("#user-info .not-login").show()}}),BDWM.init("",function(){$("#page-login, #page-register, #page-spindex, #page-register-done").length>0||("undefined"==typeof login||0==window.login?(window.chatting&&window.chatting.disconnect(),$("#bdwm-chatting").remove()):0==$("#bdwm-chatting").length&&window.ua&&"mobile"!=ua.device.type.toLowerCase()?window.chatting=new BDWM.Chatting:window.chatting||(window.chatting=null),window.chatting&&window.chatting.connect())}),$('[data-action="user-list-trigger"]').click(function(t){var e=$(this).parent();e.hasClass("clicked")?resetStatus():(resetStatus(),e.addClass("clicked"),$(".btn-list").stop().slideDown(300)),t.stopPropagation()}),$("body").click(resetStatus),$("#icon-mail").click(function(t){t.stopPropagation(),resetStatus(),$("#icon-mail").addClass("clicked"),$(".mail-extend-menu").show(100)}),$("#icon-setting").click(function(t){t.stopPropagation(),resetStatus(),$("#icon-setting").addClass("clicked"),$(".setting-extend-menu").show(100)}),$(".mask-transparent").click(resetStatus),BDWM.init("",function(){$('.paging [data-action="goto-link"]').click(function(){var t=$(this).closest(".paging"),e=t.find('[data-role="goto-input"]').val();e||BDWM.alert({text:"请输入正确的页码"});var a=window.location.href.replace(/(&?)page=[^&]*/,"");"#"==a.charAt(a.length-1)&&(a=a.substr(0,a.length-1)),e>1&&(a.indexOf("?")==-1&&(a+="?"),a+="&page="+e),a=a.replace("?&","?"),a=a.replace(/\?$/,""),BDWM.redirect(a)}),$(".paging").each(function(){var t=$(this);t.find('[data-role="goto-input"]').keydown(function(e){13==e.keyCode&&t.find('[data-action="goto-link"]').click()})})}),$("#top-nav").find(".view-all").click(function(){BDWM.redirect("mail.php"),resetStatus()}),BDWM.init("",function(){$('[data-action="bdwm-make-chatting"]').click(function(t){if("undefined"!=typeof login&&login){var e=$(this).data("username");e&&window.chatting&&e!=username&&window.chatting.chatWith(e),t.stopPropagation()}}),$('[data-action="bdwm-new-mail"]').click(function(){var t=$(this).data("username");t&&t!=username&&BDWM.redirect("mail-new.php?username="+t)}),$('[data-action="bdwm-make-friend"]').click(function(){var t=$(this).data("uid"),e=$(this).data("username");e&&e!=username&&BDWM.makeFriend(t,e,"")}),$('[data-action="bdwm-delete-friend"]').click(function(){var t=$(this).data("uid"),e=$(this).data("username");e&&e!=username&&BDWM.deleteFriend(t,e)}),$('[data-action="bdwm-set-friend-remark"]').click(function(){var t=$(this).data("uid"),e=$(this).data("username");e&&e!=username&&BDWM.editFriendRemark(t)}),$('[data-action="bdwm-add-blacklist"]').click(function(){var t=$(this).data("uid"),e=$(this).data("username");e&&e!=username&&BDWM.blacklistFriend(t,e,"")}),$('[data-action="bdwm-unblacklist-friend"]').click(function(){var t=$(this).data("uid"),e=$(this).data("username");e&&e!=username&&BDWM.unBlacklistFriend(t,e,"")}),$('[data-action="bdwm-set-blacklist-friend-remark"]').click(function(){var t=$(this).data("uid"),e=$(this).data("username");e&&e!=username&&BDWM.editBlacklistFriendRemark(t)})}),BDWM.init("",function(){$('[data-action="go-to-top"]').click(function(){$("body").animate({scrollTop:0},500),$("html").animate({scrollTop:0},500)}),$('[data-action="go-to-bottom"]').click(function(){$("body").animate({scrollTop:$("#page-content").height()},500),$("html").animate({scrollTop:$("#page-content").height()},500)})}),BDWM.init("",function(){$(".file-read.image-click-view img").load(function(){var t=$(this);t.get(0).naturalWidth&&(t.get(0).naturalWidth>t.width()||t.get(0).naturalHeight>740)&&(t.click(function(){window.open(t.attr("src"),"_blank")}),t.attr("title","点击在新窗口查看原图"),t.addClass("cursor-zoom-in"))})}),BDWM.init("",function(t){$(".bdwm-editor .switch-button").click(function(){var t=$(this).closest(".bdwm-editor").find("textarea");if(t.val().length>0){var e=$(this).attr("href");return BDWM.confirm({text:"离开页面会丢失未保存的信息，确定要离开本页吗？",callback:function(t){t&&BDWM.redirect(e)}}),!1}return!0})}),BDWM.init("",function(){$('[data-action="constructing"]').click(function(t){return BDWM.alert({text:"施工中,请您绕行",timeout:1500}),t.preventDefault(),!1})}),BDWM.init("",function(){var t=BDWM.storage.get("preference-show-unread");0!=t&&"false"!=t||$('[data-role="unread-dot"]').css({background:"transparent",color:"transparent",opacity:0}),$("#auto-alert").length&&BDWM.alert({text:$("#auto-alert").text()})});try{$.support.pjax&&($.pjax.defaults.timeout=8e3,$(document).on("pjax:click",function(t,e){e.url.indexOf("/thread.php?")>0&&BDWM.storage.get("mode")&&e.url.indexOf("mode=")<0&&(e.url+="&mode="+BDWM.storage.get("mode"))}))}catch(e){}$(document).pjax('a:not([data-no-pjax],[href="#"],[data-action])',"#page-content"),BDWM.init("",function(){adjustFooter(),document.title=$("#bdwm-title").text()}),console.log("%c Welcome To BDWM Reborn!","color: red"),console.log("%c ┏━━━━━━━━━━━━━┫北大未名ＢＢＳ┣━━━━━━━━━━━━━┓","color: #9a0000"),console.log("　　┏┳┳┓┏╋━┓　┓┏　　　┓　　┏┳┳┓┏╋━┓━╋━　┣━━┓\n　　┏┻┻┓┏╯┓　┏┫┣┛┗━╋┛　┏┻┻┓┏╯┓　┳╋┳┛╯━╮┃\n　　┣╋━┫┃┃╋┛　┃┃┓　　┃　　┣╋━┫┃┃╋┛┃┃┃　┏━┻╯\n　　　┃╋┓┃┃┃　┏┫┃┃　　┃╮　　┃╋┓┃┃┃　┃┃┃┓┏━━┓\n　　┗╯╯╯╰┗┻┛╰┗╰┛┗━╯┛　┗╯╯╯╰┗┻┛╯┛┗╯┗━━╯\n"),console.log("%c ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛","color: #9a0000"),console.log("%c No one knows the loneliness of a monkey coder.","color: blue")}})}.call(this),function(){BDWM.init("#page-home",function(){function t(a){var n=$("#"+a+">div").length,i=e[a]||0;if($("#"+a+">div").hide(),$("#"+a+"_"+i).show(),e[a]=(i+1)%n,$("#page-home").length>0){var o=setTimeout(function(){parseInt($("#"+a).attr("data-timeout"))==o&&($("#"+a).attr("data-timeout",""),t(a))},5e3);"undefined"!=typeof $("#"+a).attr("data-timeout")&&""!=$("#"+a).attr("data-timeout")&&parseInt($("#"+a).attr("data-timeout"))!=o||$("#"+a).attr("data-timeout",o)}}var e={};t("banner_top"),t("banner_middle"),t("banner_bottom")})}(),function(){function t(){a=!1}function e(){if(!a){var t=$('[data-role="username"]').val(),e=$('[data-role="password"]').val(),n=$('[data-role="keepalive"]').prop("checked")?1:0,i=CryptoJS.MD5(e+t+e).toString().toLowerCase();t&&e&&0!=t.length&&0!=e.length&&(a=!0,$.ajax({type:"POST",url:"ajax/login.php",data:{username:t,password:e,keepalive:n,t:i},dataType:"json",timeout:5e3}).done(function(t){if(t.success)localStorage.setItem("welcome",(new Date).toDateString()),location.href="home.php";else{var e=$('[data-role="username"]'),n=$('[data-role="password"]');switch(t.error){case 4:BDWM.alert({text:"您输入的用户名不存在",timeout:2e3}),e.val(""),n.val(""),e.focus();break;case 5:BDWM.alert({text:"您输入的密码有误，请重新输入",timeout:2e3}),n.val(""),n.focus();break;default:BDWM.alert({text:"其他错误发生辣>,<",timeout:2e3})}}a=!1}).fail(function(){BDWM.alert({text:"网络错误.",timeout:2e3}),a=!1}))}}BDWM.init("#page-login",function(){t(),$('[data-action="login"]').click(e),$('[data-role="username"],[data-role="password"]').on("keydown",function(t){13==t.keyCode&&e()})});var a=!1}(),function(){function t(){d=!1,l=!1,u=!1,p=$(".bdwm-editor").data("parentid"),h=$(".bdwm-editor").data("mode"),m=$(".bdwm-editor").find('[data-role="quote-mode"]').val(),v=null,g=$("#new-mail-module").length>0}function e(){return ua&&"ie"==ua.browser.family.toLowerCase()}function a(){$('[data-action="new-mail-publish"]').click(r),g?$("#new-mail-textarea").keydown(function(t){return 13!=t.keyCode||!t.metaKey&&!t.ctrlKey||($('[data-action="new-mail-publish"]').click(),!1)}):(f=e()?$("#new-mail-textarea"):$("#new-mail-textarea").bdwm_editor({})[0],$("#new-mail-textarea").on("send",r)),s=(new BDWM.FriendSelector).trigger($('[data-action="friends-select"]')),s.submit(function(t,e){var a="";_.each(t,function(t){a+=t.name+"; "}),_.each(e,function(t){a+=t+"; "}),$('input[data-role="receivers"]').val(a)}).beforeShow(function(){i();var t=$('input[data-role="receivers"]').val(),e=_.uniq(_.compact(t.replace(/\s/g,"").split(/;|,/)));s.selected(e)}),c=new BDWM.FileUploader({dir:$('[data-action="file-upload"]').data("upload-dir"),action:"ajax/upload.php",onSubmit:function(t,e){console.log("id="+t+" ,filename="+e+". onSubmit!")},onComplete:function(t,e,a){console.log(a),console.log("id="+t+" ,filename="+e+". onComplete!"),u=!0}}).trigger($('[data-action="file-upload"]'))}function n(){if(m=$(".bdwm-editor").find('[data-role="quote-mode"]').val(),"reply"==h)$.ajax({type:"POST",url:"ajax/get_mail_quote.php",data:{postid:p,mode:m},dataType:"json",timeout:4e3}).done(function(t){if(t.success){var a="<p><br></p><p><br></p>";v=t.quote,a+=t.quote+"<p><br></p>",e()||f.inject(a)}}).fail();else if("from-post"==h){var t=$(".bdwm-editor").data("frombid"),a=$(".bdwm-editor").data("frompostid");$.ajax({type:"POST",url:"ajax/get_post_quote.php",data:{postid:a,mode:m,bid:t},dataType:"json",timeout:4e3}).done(function(t){if(t.success){v=t.quote;var a="<p><br></p><p><br></p>";a+=t.quote+"<p><br></p>",e()||f.inject(a)}}).fail()}}function i(){d||l||(l=!0,$.ajax({type:"POST",url:"ajax/get_friends.php",dataType:"json",timeout:4e3}).done(function(t){if(t.success=!0){var e=[];console.log(t.result),_.each(t.result,function(t){e.push({uid:t.uid,name:t.uinfo.username})}),s.data(e),d=!0}l=!1}).fail(function(){l=!1}))}function o(t,e){$.ajax({type:"POST",url:"ajax/get_userinfo_by_names.php",data:{names:JSON.stringify(t)},dataType:"json",timeout:4e3}).done(function(a){if(a.success){var n="";if(_.each(a.result,function(e,a){0==e&&(n+='"'+t[a]+'"')}),n.length)BDWM.alert({text:"用户"+n+"不存在"});else{var i=[];_.each(a.result,function(t,e){i.push(t.id)}),e(i)}}else BDWM.alert({text:"网络错误，请稍后重试"})}).fail(function(){BDWM.alert({text:"网络错误，请稍后重试"})})}function r(){if($('[data-action="new-mail-publish"]').attr("disabled"))return!1;var t=$('[data-role="receivers"]').val(),a=$('[data-role="mail-title"]').val();if(0==t.length)return void BDWM.alert({text:"收件人不可为空"});if(0==a.length)return void BDWM.alert({text:"标题不可为空"});var n=[];return g?n=[{type:"ansi",content:$("#new-mail-textarea").val()}]:e()?(n=v?BDWM.parser("<div>"+v+"</div>"):[],n.unshift($.extend(!0,{},BDWM.defaultStyle,{content:f.val()+"\n"}))):n=f.toStruct(),0==n.length?void BDWM.alert({text:"内容不可为空"}):(t=_.uniq(_.compact(t.replace(/\s/g,"").split(/;|,/))),void o(t,function(e){var i={rcvuids:JSON.stringify(e),title:a,content:JSON.stringify(n),attachpath:u?$('[data-action="file-upload"]').data("upload-dir"):"",postinfo:{}};"reply"==h&&(i.postinfo.parentid=parseInt(p)),i.postinfo=JSON.stringify(i.postinfo);var o=$('[data-role="signature"]').val();if("random"==o){var r=parseInt($('[data-role="signature"]').data("signature-count"));o=Math.floor(r*Math.random())%r,i.signature=o}else""!=o&&(i.signature=parseInt(o),isNaN(i.signature)&&(i.signature=""));$.ajax({type:"POST",url:"ajax/create_mail.php",data:i,dataType:"json",timeout:1e4}).done(function(a){if(a.success){var n="";_.each(e,function(e,i){_.indexOf(a.sent,e)==-1&&(n+=" "+t[i])}),n.length?BDWM.alert({text:"部分成功，发送给用户"+n+" 的信件未发送成功"}):BDWM.alert({text:"发送成功",timeout:1200,callback:function(){BDWM.redirect("mail.php?type=4"),BDWM.reload()}})}else 9==a.error?BDWM.alert({text:"您的发信权已被封禁"}):BDWM.alert({text:"发送失败，请稍后重试"})}).fail(function(){BDWM.alert({text:"网络错误，请稍后重试"})})}))}BDWM.init("#page-mail-new, #new-mail-module",function(){t(),a(),n(),$(".bdwm-editor").find('[data-role="quote-mode"]').change(n)});var s,c,d,l,u,f,p,h,m,v,g}(),function(){function t(){$("#new-mail-textarea").keydown(function(t){return 13!=t.keyCode||!t.metaKey&&!t.ctrlKey||($('[data-action="new-mail-reply"]').click(),!1)}),$('[data-action="new-mail-reply"]').click(function(){var t=$("#new-mail-textarea").val();if(!t||0==t.length)return BDWM.alert({text:"内容不可为空"}),!1;var e=$(".bdwm-editor").data("parentid"),a=$(".bdwm-editor").data("uid"),n=$(".bdwm-editor").data("title");$.ajax({type:"POST",url:"ajax/get_mail_quote.php",data:{postid:e,mode:"simple"},dataType:"json",timeout:4e3}).done(function(i){if(i.success){var o=BDWM.parser("<div>"+i.quote+"</div>");o.unshift($.extend(!0,{},BDWM.defaultStyle,{content:t+"\n"})),i={rcvuids:JSON.stringify([a]),title:n,content:JSON.stringify(o),postinfo:JSON.stringify({parentid:parseInt(e)})};var r=$('[data-role="signature"]').val();if("random"==r){var s=parseInt($('[data-role="signature"]').data("signature-count"));r=Math.floor(s*Math.random())%s,i.signature=r}else""!=r&&(i.signature=parseInt(r));$.ajax({type:"POST",url:"ajax/create_mail.php",data:i,dataType:"json",timeout:4e3}).done(function(t){t.success&&t.sent.length>=1?BDWM.alert({text:"发送成功",timeout:1200,callback:function(){BDWM.redirect("mail.php?type=4"),BDWM.reload()}}):9==t.error?BDWM.alert({text:"您的发信权已被封禁"}):BDWM.alert({text:"发送失败，请稍后重试"})}).fail(function(){BDWM.alert({text:"网络错误，请稍后重试"})})}}).fail(function(){BDWM.alert({text:"网络错误，请稍后重试"})})})}function e(){var t=$("#mail-read");if(!t)return!1;var e=t.data("postid");BDWM.opReprint(t.find("[data-action=forward-to-post]"),{from:"mail",postid:e}),BDWM.opResend(t.find("[data-action=forward-to-mail]"),{from:"mail",postid:e}),BDWM.opCollect(t.find("[data-action=collect]"),{from:"mail",postid:e},!0),t.find('[data-action="delete-mail"]').click(function(){var t="mail.php";BDWM.confirm({title:"是否确认删除此站内信？",callback:function(a){a&&$.ajax({type:"POST",url:"ajax/operate_mail.php",data:{list:JSON.stringify([parseInt(e)]),action:"delete"},dataType:"json",timeout:4e3}).done(function(e){0==e.results[0]?BDWM.redirect(t):BDWM.alert({text:"删除错误"})}).fail(function(){BDWM.alert({text:"网络错误，请稍后重试"})})}})})}function a(){var t=function(e,a,n){$(e).contents().each(function(){3==this.nodeType?this.nodeValue=this.nodeValue.replace(new RegExp(a,"g"),n):t(this,a,n)})},e=$(".content"),a="",n=e.find(".file-read:not(.signature)");if(n.find("p.code").length>0)e.find('[data-action="ascii-toggle"]').hide();else{var i=e.find('[data-action="ascii-toggle"]');i.click(function(){var e=$(this);e.hasClass("active")?(e.removeClass("active"),n.removeClass("pre"),n.html(a)):(e.addClass("active"),a=n.html(),n.addClass("pre"),t(n,"\\s"," "))}),"undefined"!=typeof i.attr("data-ascii-default-on")&&i.click()}}BDWM.init("#page-mail",function(){t(),e(),a()})}(),function(){function t(){p=$(".list-item .input-wrapper :checkbox"),v=$("#input-sa"),h=[],m=[]}function e(t){return $.ajax({type:"POST",url:g,data:{list:JSON.stringify(t)},dataType:"json"})}function a(t){return $.ajax({type:"POST",url:b,data:{list:JSON.stringify(t)},dataType:"json"})}function n(t){return $.ajax({type:"POST",url:w,data:{list:JSON.stringify(t),action:"mark"},dataType:"json"})}function i(t){return $.ajax({type:"POST",url:w,data:{list:JSON.stringify(t),action:"unmark"},dataType:"json"})}function o(){$(".list-item").each(function(){m.push(parseInt($(this).attr("data-itemid")))}),v.prop("checked",!1),v.click(function(){p.prop("checked",this.checked),r()});var t=$("#mail-delete"),i=$("#mail-mark"),o=$("#mail-set-read");o.click(function(){e(h).done(function(t){t.success?(h.forEach(function(t){var e=$('[data-itemid="'+t+'"]');e.find(".dot").removeClass("unread"),e.find('li[data-action="mark-read"]').remove()}),p.prop("checked",!1)):console.log(t)}).fail(function(){console.log("set selected mail read failed.")})}),i.click(function(){n(h).done(function(t){t.success?(h.forEach(function(e,a){var n=$('[data-itemid="'+e+'"]').find(".star");n.hasClass("active")||t.results[a]||s($('[data-itemid="'+e+'"]'),!0)}),p.prop("checked",!1)):console.log(t)}).fail(function(){console.log("mark selected mail failed.")})}),t.click(function(){$.isEmptyObject(h)||BDWM.confirm({title:"是否删除当前信件？",text:"被删除的信件将无法挽回<br>有星标的信件无法删除",callback:function(t){t&&a(h).done(function(t){t.success?BDWM.reload():console.log(t)}).fail(function(){console.log("delete selected mail failed.")})}})})}function r(){h=[],p.each(function(){if(this.checked){var t=$(this).closest(".list-item");h.push(parseInt(t.attr("data-itemid")))}}),$.isEmptyObject(h)?$(".option-button-group").removeClass("show"):$(".option-button-group").addClass("show")}function s(t,e){e?(t.find(".star").addClass("active"),t.find('li[data-action="mark-mail"]').text("取消星标")):(t.find(".star").removeClass("active"),t.find('li[data-action="mark-mail"]').text("星标"))}function c(){p.prop("checked",!1),p.click(function(){this.checked||v.prop("checked",!1),r()})}function d(){$('[data-action="mark-mail"]').click(function(){var t=$(this).closest(".list-item"),e=t.attr("data-itemid"),a=t.find(".star");a.hasClass("active")?i([parseInt(e)]).done(function(e){e.success&&0==e.results[0]?s(t,!1):console.log(e)}).fail(function(){console.log("mark selected mail failed.")}):n([parseInt(e)]).done(function(e){e.success&&0==e.results[0]?s(t,!0):console.log(e)}).fail(function(){console.log("mark selected mail failed.")})})}function l(){$('[data-action="delete-mail"]').click(function(){var t=$(this).closest(".list-item"),e=t.attr("data-itemid");BDWM.confirm({title:"是否删除当前信件？",text:"被删除的信件将无法挽回",callback:function(t){t&&a([parseInt(e)]).done(function(t){t.success?BDWM.reload():console.log(t)}).fail(function(){console.log("delete selected mail failed.")})}})})}function u(){$('[data-action="mark-read"]').click(function(){var t=$(this).closest(".list-item"),a=t.attr("data-itemid");e([parseInt(a)]).done(function(e){e.success?(t.find(".dot").removeClass("unread"),t.find('li[data-action="mark-read"]').remove()):console.log(e)}).fail(function(){console.log("set selected mail read failed.")})})}function f(t){var e=t.find(".search-box");BDWM.searchBox(e,{name:"search-in-mail",placeholder:"搜索站内信",confirm:function(t){var e="mail.php?mode=6&key="+t;BDWM.redirect(e)},tips:{url:!1,getItemsFromData:function(t,e){var a=[],n=/^[A-Za-z]*$/;return n.test(e)&&a.push({str:e,url:"mail.php?mode=6&key="+e,text:"搜索"+e+"相关发件人"}),a.push({str:e,url:"mail.php?mode=6&key="+e,text:"搜索"+e+"相关站内信标题"}),a},modifyViewFromItem:!1,confirm:function(t){BDWM.redirect(t.url)}},history:!1})}BDWM.init("#page-mail-list",function(){t(),o(),d(),l(),u(),c(),f($("#page-mail"))});var p,h,m,v,g="ajax/set_mail_read.php",b="ajax/delete_mail.php",w="ajax/operate_mail.php"}(),function(){function t(){r={},o=!1}function e(){$("select.cs-select").each(function(){BDWM.initSelect(this)})}function a(){$("form .form-row.file").each(function(){var t=$(this);t.find("input[type=file]").change(function(){t.find(".preview-link").text("上传中...").attr("href",""),t.find(".remove-link").hide();var e=$(this).clone(!0);BDWM.file_upload(this,"ajax/manager_upload.php","type="+t.data("type"),function(){},function(){},function(a,n,i){if(i=i||{success:!1},i.success){var o=i.name,r=i.url;t.find(".preview-link").text(o).attr("href",r),t.find(".remove-link").show(),"url"==t.find("input[type=hidden]").data("need")?t.find("input[type=hidden]").val(r):t.find("input[type=hidden]").val(o)}else t.find(".preview-link").text("上传失败").attr("href","");t.find("label[for]").prepend(e)})}),t.find('[data-action="remove-file"]').click(function(){t.find(".preview-link").text(""),t.find("input[type=hidden]").val("")})})}function n(){}function i(){$("form[data-ajaxsubmit]").submit(function(t){if(t.preventDefault(),o)return!1;var e=$(this),a=e.attr("method").toLowerCase(),n=e.attr("action"),i=e.data("then");e.find(".form-row").removeClass("invalid");var s=function(t){return e.find("[name='"+t+"']").closest(".form-row").addClass("invalid"),null},c={},d=!0;e.find("input[type=number],input[type=text],input[type=hidden],input[type=radio]:checked,input[type=checkbox]:checked").each(function(){var t=$(this),e=$(this).closest(".form-row");t.attr("required")&&""==t.val()?(e.addClass("invalid"),d=!1):""!=t.val()&&(c[t.attr("name")]=t.val())});var l=c,u=e.data("trait")||"null";if(r[u]instanceof Function){var f=r[u](l,s);f?l=f:d=!1}return d&&(o=!0,$[a](n,l,function(t){t.success?BDWM.alert({text:"保存成功！",timeout:2e3,callback:i?BDWM.redirect.bind(BDWM,i):BDWM.reload.bind(BDWM)}):9==t.error?BDWM.alert({text:"您不具备足够权限进行此操作"}):BDWM.alert({text:"操作失败."}),o=!1},"json").fail(function(){BDWM.alert({text:"网络错误，请稍后再试……"}),o=!1})),!1})}BDWM.init(".page-manager",function(){t(),e(),a(),n(),i()});var o,r;BDWM.init("#page-manager-index",function(){$('[data-action="delete-index"]').click(function(){var t=$(this).data("index-name");$.ajax({url:"ajax/manager_index.php",method:"post",data:"action=delete&name="+t,timeout:1e4,dataType:"json"}).done(function(t){t.success?BDWM.alert({text:"删除成功！",timeout:2e3,callback:BDWM.redirect.bind(BDWM,"manager-index.php")}):9==t.error?BDWM.alert({text:"您不具备足够权限进行此操作"}):BDWM.alert({text:"操作失败."})}).fail(function(){BDWM.alert({text:"网络错误，请稍后再试……"})})})}),BDWM.init("#page-manager-banner",function(){$('[data-action="delete-banner"]').click(function(){var t=$(this).data("banner-name");$.ajax({url:"ajax/manager_banner.php",method:"post",data:"action=delete&name="+t,timeout:1e4,dataType:"json"}).done(function(t){t.success?BDWM.alert({text:"删除成功！",timeout:2e3,callback:BDWM.redirect.bind(BDWM,"manager-banner.php")}):9==t.error?BDWM.alert({text:"您不具备足够权限进行此操作"}):BDWM.alert({text:"操作失败."})}).fail(function(){BDWM.alert({text:"网络错误，请稍后再试……"})})})}),BDWM.init("#page-manager-logo",function(){$('[data-action="delete-logo"]').click(function(){var t=$(this).data("logo-name");$.ajax({url:"ajax/manager_logo.php",method:"post",data:"action=delete&name="+t,timeout:1e4,dataType:"json"}).done(function(t){t.success?BDWM.alert({text:"删除成功！",timeout:2e3,callback:BDWM.redirect.bind(BDWM,"manager-logo.php")}):9==t.error?BDWM.alert({text:"您不具备足够权限进行此操作"}):BDWM.alert({text:"操作失败."})}).fail(function(){BDWM.alert({text:"网络错误，请稍后再试……"})})})}),BDWM.init("#page-manager-top",function(){$('[data-action="remove-item"]').click(function(){var t=$(this).data("item-board"),e=$(this).data("item-threadid");$.ajax({url:"ajax/manager_top.php",method:"post",data:"action=delete&board="+t+"&threadid="+e,timeout:1e4,dataType:"json"}).done(function(t){t.success?BDWM.alert({text:"删除成功！",timeout:2e3,callback:BDWM.reload.bind(BDWM)}):9==t.error?BDWM.alert({text:"您不具备足够权限进行此操作"}):BDWM.alert({text:"操作失败."})}).fail(function(){BDWM.alert({text:"网络错误，请稍后再试……"})})})}),BDWM.init("#page-manager-home-advert",function(){$('[data-action="delete-home-advert"]').click(function(){var t=$(this).data("advert-id");$.ajax({url:"ajax/manager_home_advert.php",method:"post",data:"action=delete&id="+t,timeout:1e4,dataType:"json"}).done(function(t){t.success?BDWM.alert({text:"删除成功！",timeout:2e3,callback:BDWM.redirect.bind(BDWM,"manager-home-advert.php")}):9==t.error?BDWM.alert({text:"您不具备足够权限进行此操作"}):BDWM.alert({text:"操作失败."})}).fail(function(){BDWM.alert({text:"网络错误，请稍后再试……"})})})}),BDWM.init("#page-manager-board-advert",function(){$('[data-action="delete-board-advert"]').click(function(){var t=$(this).data("advert-id");$.ajax({url:"ajax/manager_board_advert.php",method:"post",data:"action=delete&id="+t,timeout:1e4,dataType:"json"}).done(function(t){t.success?BDWM.alert({text:"删除成功！",timeout:2e3,callback:BDWM.redirect.bind(BDWM,"manager-board-advert.php")}):9==t.error?BDWM.alert({text:"您不具备足够权限进行此操作"}):BDWM.alert({text:"操作失败."})}).fail(function(){BDWM.alert({text:"网络错误，请稍后再试……"})})})}),BDWM.init("#page-manager",function(){$('[data-action="opt"]').click(function(t){BDWM.confirm({text:"注意本操作只能执行一次，且需要用电脑浏览器执行<br>如果不能执行了请联系技术站务重置",title:"Warning",callback:function(t){t&&(location.href="manager-otp.php")}})})})}(),function(){function t(){r=!1,c=$(".bdwm-editor").data("parentid"),d=$(".bdwm-editor").data("mode"),l=$(".bdwm-editor").data("bid"),u=$(".bdwm-editor").data("type"),f=$(".bdwm-editor").find('[data-role="quote-mode"]').val(),p=null,h=$(".bdwm-editor").data("postid");var t=$("#signature-origin").text();m=t?$("#signature-origin").text()||"[]":"[]",v=!1}function e(){return ua&&"ie"==ua.browser.family.toLowerCase()}function a(){if(s=e()?$("#new-post-textarea"):$("#new-post-textarea").bdwm_editor({})[0],$('[data-action="new-post-publish"]').click(i),$("#new-post-textarea").on("send",i),o=new BDWM.FileUploader({dir:$('[data-action="file-upload"]').data("upload-dir"),action:"ajax/upload.php",onSubmit:function(t,e){console.log("id="+t+" ,filename="+e+". onSubmit!")},onComplete:function(t,e,a){console.log(a),console.log("id="+t+" ,filename="+e+". onComplete!"),r=!0}}).trigger($('[data-action="file-upload"]')),"modify"==d){var t=$("#post-origin");if(e()){var a="";_.each(BDWM.parser(t),function(t){"quotehead"!=t.type&&"quote"!=t.type&&(a+=t.content||"")}),s.val(a),t.children("p:not(.quotehead,.blockquote)").remove(),p=t.html(),console.log("quote: "+p),t.remove()}else!t||0==t.length||0==t.text().length&&0==t.find("img").length?(t="<p><br></p>",s.inject(t)):(s.injectObject(t),t.remove());var n=$('[data-action="file-upload"]').data("file-list");n.length>0&&(r=!0),_.each(n,function(t){o.insertFileListItem(null,t,t)})}$("#input-anonymous").change(function(){var t=$(this);t.prop("checked")?(t.closest(".bdwm-editor").find('[data-role="signature"]').attr("data-signature-no-history","true"),t.closest(".bdwm-editor").find('[data-option][data-value=""]').click().closest(".cs-select").removeClass("cs-active"),$("#input-remind").prop("disabled","disabled"),$("#input-remind").siblings("other").addClass("disabled")):(t.closest(".bdwm-editor").find('[data-role="signature"]').removeAttr("data-signature-no-history"),$("#input-remind").removeAttr("disabled"),$("#input-remind").siblings(".other").removeClass("disabled"))}),$("#input-anonymous").prop("checked")&&($("#input-remind").prop("disabled","disabled"),$("#input-remind").siblings(".other").addClass("disabled"));var c=BDWM.storage.get("preference-subscribe-reply",!0);"true"!=c&&1!=c||$("#input-remind").prop("checked","checked")}function n(){"reply"==d&&(f=$(".bdwm-editor").find('[data-role="quote-mode"]').val(),$.ajax({type:"POST",url:"ajax/get_post_quote.php",data:{postid:c,mode:f,bid:l},dataType:"json",timeout:4e3}).done(function(t){if(t.success){p=t.quote;var a="<p><br></p><p><br></p>";a+=t.quote+"<p><br></p>",e()||s.inject(a)}}).fail())}function i(){if($('[data-action="new-post-publish"]').attr("disabled"))return!1;if(v)return!1;var t=!1,a=$('[data-role="post-title"]').val();if(0==a.length)return void BDWM.alert({text:"标题不可为空"});var n=[];if(e()?(n=p?BDWM.parser("<div>"+p+"</div>"):[],n.unshift($.extend(!0,{},BDWM.defaultStyle,{content:s.val()+"\n"}))):n=s.toStruct(),0==n.length)return void BDWM.alert({text:"内容不可为空"});var i=$(".bdwm-editor").data("bid"),o={title:a,content:JSON.stringify(n),bid:i,attachpath:r?$('[data-action="file-upload"]').data("upload-dir"):"",postinfo:{}};"reply"==d&&(o.postinfo.parentid=parseInt(c)),!$("#input-noreply").prop("disabled")&&$("#input-noreply").prop("checked")&&(o.postinfo.no_reply=!0),!$("#input-remind").prop("disabled")&&$("#input-remind").prop("checked")&&(o.postinfo.mail_re=!0),!$("#input-anonymous").prop("disabled")&&$("#input-anonymous").prop("checked")&&(o.postinfo.anony=!0),o.postinfo=JSON.stringify(o.postinfo),"modify"==d&&(o.postid=h);var l=$('[data-role="signature"]').val();if("random"==l){var f=parseInt($('[data-role="signature"]').data("signature-count"));l=Math.floor(f*Math.random())%f,o.signature=l}else"keep"==l?o.signature=m:""!=l&&(o.signature=parseInt(l),isNaN(o.signature)&&(o.signature=""));!$("#input-forward").prop("disabled")&&$("#input-forward").prop("checked")&&$("#input-forward").data("uid")&&(o.forward_uid=$("#input-forward").data("uid"),t=!0);var g=function(t){"reply"==d&&"origin"==BDWM.storage.get("preference-reply-redirect")?"single"==BDWM.getCookie("mode")?BDWM.redirect("post-read-single.php?bid="+i+"&postid="+c):BDWM.redirect("post-read.php?bid="+i+"&page=a&threadid="+t.result.threadid+"&postid="+c+"#"+c):"single"==BDWM.getCookie("mode")?BDWM.redirect("post-read-single.php?bid="+i+"&postid="+t.result.postid):BDWM.redirect("post-read.php?bid="+i+"&page=a&threadid="+t.result.threadid+"&postid="+t.result.postid+"#"+t.result.postid)};v=!0,$.ajax({type:"POST",url:"modify"==d?"ajax/edit_post.php":"ajax/create_post.php",data:o,dataType:"json",timeout:1e4}).done(function(e){v=!1,e.success?t?e.warn_forward?BDWM.alert({text:"发送成功，但抄送给原作者失败",timeout:4e3,callback:function(){g(e)}}):BDWM.alert({text:"发送成功，抄送给原作者成功",timeout:4e3,callback:function(){g(e)}}):"modify"==d?BDWM.redirect("post-read-single.php?bid="+i+"&postid="+e.result.postid+("undefined"==typeof u?"":"&type="+u)):g(e):BDWM.alert({text:"发送失败，请稍后重试"})}).fail(function(){v=!1,BDWM.alert({text:"网络错误，请稍后重试"})})}BDWM.init("#page-post-new",function(){t(),a(),n(),$(".bdwm-editor").find('[data-role="quote-mode"]').change(n)});var o,r,s,c,d,l,u,f,p,h,m,v}(),function(){function t(){return window.location.pathname.indexOf("post-read-single.php")>=0}function e(t){if("right"==BDWM.storage.get("preference-post-owner-pos")){t=$(t);var e=t.find(".post-main"),a=t.find(".post-owner");1==a.length&&1==e.length&&(a=a.clone(),t.find(".post-owner").remove(),
    e.after(a))}}function a(t){var e=t.find(".wechat");if(e.length>0){var a="/qr/?u=";t.find(".wechat-qrcode>img").attr("src",a+encodeURIComponent(window.location.href)),e.mouseover(function(){t.find(".wechat-qrcode").show(80)}),e.mouseout(function(){t.find(".wechat-qrcode").hide(30)})}}function n(t){function e(t){var e=$(t);e.find(".signature").removeClass("stick-down"),e.find(".content").height()<=203&&e.find(".signature").addClass("stick-down")}t=$(t),t.find(".content img").one("load",function(){e($(this).closest(".post-card"))}).each(function(){this.complete&&$(this).load()}),e(t)}function i(t){BDWM.urlCopier(t)}function o(t){t=$(t);var e=t.data("bid"),a=t.data("postid"),n=t.find(".operations");BDWM.opReprint(n.find('[data-action="reprint"]').closest("a"),{from:"post",bid:e,postid:a}),BDWM.opResend(n.find('[data-action="resend"]').closest("a"),{from:"post",bid:e,postid:a}),BDWM.opCollect(n.find('[data-action="collect"]').closest("a"),{from:"post",bid:e,postid:a,threadid:t.data("threadid")}),n.find('[data-action="reply-post"]').click(function(){t.find(".editor-inner-wrapper").length?(t.find(".editor-inner-wrapper").slideDown(300).find('[data-role="new-post-textarea"]').focus(),n.find('[data-action="fold-up"]').parent().show(),$(this).parent().hide()):($("new-post-textarea").closest(".editor-wrapper").find(".disable-mask").remove(),$("body").animate({scrollTop:$("#page-content").height()},700,"swing",function(){$('[data-role="new-post-textarea"]').focus()}),$("html").animate({scrollTop:$("#page-content").height()},700,"swing",function(){$('[data-role="new-post-textarea"]').focus()}))}),n.find('[data-action="fold-up"]').click(function(){t.find(".editor-inner-wrapper").slideUp(300),n.find('[data-action="reply-post"]').parent().show(),$(this).parent().hide()}),n.find('[data-action="delete-post"]').click(function(t){var n="thread.php?bid="+e,i=$(this).data("top");BDWM.confirm({title:"是否确认删除此帖？",text:1==$(this).data("self")?"30天内删除的帖子，可以在所在版面的“自删”列表里找到":"30天内删除的帖子，可以在所在版面的删除区里找到",callback:function(t){t&&$.ajax({type:"POST",url:"ajax/operate_post.php",data:{bid:e,list:JSON.stringify([parseInt(a)]),action:i?"untop":"delete"},dataType:"json",timeout:4e3}).done(function(t){0==t.results[0]?1==$(".post-card").length?BDWM.redirect(n):BDWM.reload():BDWM.alert({text:"删除错误"})}).fail(function(){BDWM.alert({text:"网络错误，请稍后重试"})})}})}),n.find('[data-action="noreply-post"]').click(function(t){$.ajax({type:"POST",url:"ajax/operate_post.php",data:{bid:e,list:JSON.stringify([parseInt(a)]),action:"noreply"},dataType:"json",timeout:4e3}).done(function(t){0==t.results[0]?BDWM.alert({text:"操作成功",timeout:2e3,callback:function(){BDWM.reload()}}):BDWM.alert({text:"操作失败"})}).fail(function(){BDWM.alert({text:"网络错误，请稍后重试"})})}),n.find('[data-action="clear-noreply-post"]').click(function(t){$.ajax({type:"POST",url:"ajax/operate_post.php",data:{bid:e,list:JSON.stringify([parseInt(a)]),action:"unnoreply"},dataType:"json",timeout:4e3}).done(function(t){0==t.results[0]?BDWM.alert({text:"操作成功",timeout:2e3,callback:function(){BDWM.reload()}}):BDWM.alert({text:"操作失败"})}).fail(function(){BDWM.alert({text:"网络错误，请稍后重试"})})})}function r(t){t=$(t),t.find(".post-owner .functions .line>span.disabled").click(function(){BDWM.dialogWithCloseIcon($("<span>您尚未登录，无法使用此功能</span>"))})}function s(t){t.find(".sl-triangle-container").each(function(){c($(this))}),t.find(".sl-triangle-container").click(function(t){var e=$(this),a=(e.find(".triangle"),e.find(".down-list"));0!=a.length&&(e.hasClass("active")?c(e):d(e))})}function c(t){var e=t.find(".triangle"),a=t.find(".down-list"),n=t.find(".trans-mask");t.removeClass("active"),e.removeClass("active"),a.slideUp(100),n.hide()}function d(t){var e=t.find(".triangle"),a=t.find(".down-list");t.addClass("active"),e.addClass("active"),a.slideDown(100);var n=t.find(".trans-mask");n.length||(n=$('<div class="trans-mask"></div>'),t.append(n),n.click(function(t){var e=$(this).closest(".sl-triangle-container");c(e),t.stopPropagation()})),n.show()}function l(t){t.find(".operations .right").each(function(){var t,e;$(this).find(".right-align").length&&($(this).find(".down-list").show(),t=_.max(_.map($(this).find(".right-align"),function(t){return $(t).width()}))+3,e=_.max(_.map($(this).find(".left-align"),function(t){return $(t).width()}))+3,$(this).find(".right-align").width(t),$(this).find(".left-align").width(e),$(this).find(".down-list").hide())})}function u(t){var e=function(t,a,n){$(t).contents().each(function(){3==this.nodeType?this.nodeValue=this.nodeValue.replace(new RegExp(a,"g"),n):e(this,a,n)})};t=$(t);var a=t.find(".body.file-read"),n=t.find(".signature.file-read");if(a.find("p.code").length>0)t.find('[data-action="ascii-toggle"]').hide();else{var i=t.find('[data-action="ascii-toggle"]');i.click(function(){var i=$(this);if(i.hasClass("active"))i.removeClass("active"),a.removeClass("pre"),a.html(a.attr("data-ascii-mode-origin")),0==n.find("p.code").length&&(n.removeClass("pre"),n.html(n.attr("data-ascii-mode-origin"))),f(t);else{i.addClass("active");var o=a.html();a.attr("data-ascii-mode-origin",o),a.addClass("pre"),0==n.find("p.code").length&&(o=n.html(),n.attr("data-ascii-mode-origin",o),n.addClass("pre"),e(n,"\\s"," ")),e(a,"\\s"," ")}}),"undefined"!=typeof i.attr("data-ascii-default-on")&&(i.click(),i.removeAttr("data-ascii-default-on"))}}function f(t){t=$(t),t.find("img.tex").unbind("dblclick").dblclick(function(){var e=$("<span class='tex'></span>").text($(this).attr("alt")).attr("src",$(this).attr("src"));$(this).replaceWith(e),f(t)}),t.find("span.tex").unbind("dblclick").dblclick(function(){var e=$("<img title='双击查看源码' class='tex' />").attr("alt",$(this).text()).attr("src",$(this).attr("src"));$(this).replaceWith(e),f(t)})}function p(e){e.find('[data-action="fold-up"]').click(function(){e.closest(".editor-inner-wrapper").slideUp(300),e.closest(".post-card").find('.operations [data-action="fold-up"]').parent().hide(),e.closest(".post-card").find('.operations [data-action="reply-post"]').parent().show()}),e.find('[data-role="input-anonymous"]').change(function(){var t=$(this);t.prop("checked")?(t.closest(".bdwm-editor").find('[data-role="signature"]').attr("data-signature-no-history","true"),t.closest(".bdwm-editor").find('[data-option][data-value=""]').click().closest(".cs-select").removeClass("cs-active")):t.closest(".bdwm-editor").find('[data-role="signature"]').removeAttr("data-signature-no-history")}),e.find('[data-role="new-post-textarea"]').keydown(function(t){return 13!=t.keyCode||!t.metaKey&&!t.ctrlKey||(e.find('[data-action="new-post-publish"]').click(),!1)}),e.find('[data-action="new-post-publish"]').click(function(){if(m)return!1;if($(this).attr("disabled"))return!1;var a=e.find('[data-role="new-post-textarea"]').val();if(!a||0==a.length)return BDWM.alert({text:"内容不可为空"}),!1;var n=e.data("bid"),i=e.find('[data-role="post-title"]').val();if(0==i.length)return void BDWM.alert({text:"标题不可为空"});var o=e.data("parentid"),r=function(e){"origin"==BDWM.storage.get("preference-reply-redirect")?t()?BDWM.redirect("post-read-single.php?bid="+n+"&postid="+o):BDWM.redirect("post-read.php?bid="+n+"&page=a&threadid="+e.result.threadid+"&postid="+o+"#"+o):t()?BDWM.redirect("post-read-single.php?bid="+n+"&postid="+e.result.postid):BDWM.redirect("post-read.php?bid="+n+"&page=a&threadid="+e.result.threadid+"&postid="+e.result.postid+"#"+e.result.postid)};m=!0,$.ajax({type:"POST",url:"ajax/get_post_quote.php",data:{postid:o,mode:"simple",bid:n},dataType:"json",timeout:4e3}).done(function(t){if(t.success){var s=BDWM.parser("<div>"+t.quote+"</div>");s.unshift($.extend(!0,{},BDWM.defaultStyle,{content:a+"\n"})),t={title:i,content:JSON.stringify(s),bid:n,postinfo:{parentid:parseInt(o)}},!e.find('[data-role="input-anonymous"]').prop("disabled")&&e.find('[data-role="input-anonymous"]').prop("checked")&&(t.postinfo.anony=!0),"true"==e.find('[data-role="input-noreply"]').val()&&(t.postinfo.no_reply=!0);var c=BDWM.storage.get("preference-subscribe-reply",!0);t.postinfo.anony||"true"!=c&&1!=c||(t.postinfo.mail_re=!0);var d=e.find('[data-role="signature"]').val();if("random"==d){var l=parseInt(e.find('[data-role="signature"]').data("signature-count"));d=Math.floor(l*Math.random())%l,t.signature=d}else""!=d&&(t.signature=parseInt(d),isNaN(t.signature)&&(t.signature=""));t.postinfo=JSON.stringify(t.postinfo),$.ajax({type:"POST",url:"ajax/create_post.php",data:t,dataType:"json",timeout:1e4}).done(function(t){m=!1,t.success?e.data("inner")?(e.closest(".editor-inner-wrapper").slideUp(300),e.closest(".post-card").find('.operations [data-action="fold-up"]').parent().hide(),e.closest(".post-card").find('.operations [data-action="reply-post"]').parent().show(),e.find('[data-role="new-post-textarea"]').val(""),BDWM.alert({text:"发布成功",timeout:1500})):r(t):BDWM.alert({text:"发布失败，请稍后重试"})}).fail(function(){m=!1,BDWM.alert({text:"网络错误，请稍后重试"})})}else m=!1}).fail(function(){m=!1,BDWM.alert({text:"网络错误，请稍后重试"})})})}function h(){$(".post-card.post-fold-up").click(function(){$(this).siblings(".post-highlight").slideDown(),$(this).slideUp()})}BDWM.init("#page-post",function(){var t=$("#page-post"),c=$(".post-card");_.map(c,e),s(t),l(t),i($(".copy-link")),a($(".share")),_.map(c,r),_.map(c,o),_.map(c,n),_.map(c,u),_.map(c,f),$(".bdwm-editor").each(function(){p($(this))}),window.hljs&&(hljs.configure({useBR:!0}),$("p.code").each(function(t,e){$(this).attr("data-init")||(hljs.highlightBlock(e),$(this).css({"white-space":"pre-wrap"})),$(this).attr("data-init","true")})),m=!1,h()});var m}(),function(){function t(){c=0,d=!1}function e(){$("select.cs-select").each(function(){BDWM.initSelect(this)}),$('.form[data-role="form-6"]').find('[data-role="emailsuf"]').change(function(){$(this).val().indexOf("ruc")>=0?($(this).closest(".row").find(".instruction").text("仅可使用学工号邮箱"),$(this).closest(".row").find(".warning-info").text("请填写学工号邮箱")):($(this).closest(".row").find(".instruction").text(""),$(this).closest(".row").find(".warning-info").text("请填写邮箱"))})}function a(){$(".tabs").children().each(function(t){$(this).click(function(){"undefined"==typeof $(this).attr("disabled")&&n(t)})}),n((parseInt($(".form-content").data("type"))||1)-1)}function n(t){c=t,$(".tabs").children().removeClass("active").eq(t).addClass("active"),$(".tab-infos").children().addClass("hidden").eq(t).removeClass("hidden"),$(".form").addClass("hidden").eq(t).removeClass("hidden")}function i(){$('[data-action="clear-form"]').click(function(){$(this).closest(".form").find("input[type=text]").val("")})}function o(){$('[data-action="submit-form"]').click(function(){if(d)return!1;var t=$(this).closest(".form"),e=t.data("path"),a={};t.find("input[type=text], input[type=hidden], input[type=password], input[type=tel], input[type=number], input[type=email], select, input[type=radio]:checked, input[type=checkbox]").each(function(){"checkbox"!=$(this).attr("type")?a[$(this).data("role")]=$(this).val():a[$(this).data("role")]=$(this).prop("checked")?1:0});var n=r(a);return t.find(".row").removeClass("warning warning-custom"),n.success?(d=!0,void $.ajax({type:"POST",url:e,data:n.data,dataType:"json",timeout:1e4}).done(function(e){e.success?s(n.data):21==e.error?t.find('[data-role="username"]').focus().closest(".row").addClass("warning-custom").find(".warning-info-custom").text("ID已经被注册"):32==e.error?t.find('[data-role="username"]').focus().closest(".row").addClass("warning-custom").find(".warning-info-custom").text("该用户名被禁止使用"):33==e.error?t.find('[data-role="email"]').focus().closest(".row").addClass("warning-custom"):38==e.error?t.find('[data-role="password"]').focus().closest(".row").addClass("warning"):BDWM.alert({text:"注册失败"}),d=!1}).fail(function(){BDWM.alert({text:"网络错误,请稍后再试",timeout:3e3}),d=!1})):(_.each(n.errors,function(e,a){t.find('[data-role="'+e+'"]').closest(".row").addClass("warning"),0==a&&t.find('[data-role="'+e+'"]').focus()}),!1)})}function r(t){var e={success:!0,errors:[]};if("undefined"!=typeof t.username&&(t.username.match(/^[A-Za-z]{2,12}$/)||e.errors.push("username")),"undefined"!=typeof t.email&&(1!=t.type||t.email.match(/^[0-9]{5}([0-9]{3}([0-9]{2})?)?$/)||e.errors.push("email"),6==t.type&&(t.emailsuf.indexOf("ruc")>=0?t.email&&t.email.match(/^20[0-9]{8}$/)||e.errors.push("email"):t.email&&t.email.match(/^[A-Za-z0-9][A-Za-z0-9-_.]*$/)||e.errors.push("email"))),"undefined"!=typeof t.nickname&&t.nickname.match(/[\n,\r]/)&&e.errors.push("nickname"),"undefined"!=typeof t.password&&(t.password.length<8||t.password.replace(/[^\x00-\xff]/g,"aa").length>60)&&e.errors.push("password"),"undefined"!=typeof t.password_repeat&&(t.password_repeat!=t.password&&e.errors.push("password_repeat"),delete t.password_repeat),"undefined"!=typeof t.birthyear)if(t.birthyear=parseInt(t.birthyear),t.birthmonth=parseInt(t.birthmonth),t.birthday=parseInt(t.birthday),isNaN(t.birthday)||isNaN(t.birthmonth)||isNaN(t.birthyear)||t.birthyear<1900)e.errors.push("birthyear");else{var a=new Date(t.birthyear,t.birthmonth-1,t.birthday);a.getFullYear()==t.birthyear&&a.getMonth()==t.birthmonth-1&&a.getDate()==t.birthday||e.errors.push("birthyear")}"undefined"!=typeof t.stu_num&&(t.stu_num.match(/^[0-9]{8,10}$/)||e.errors.push("email"));var n=["nickname","dept","addr","phone","realname","st_year","st_month","gra_year","gra_month"];return _.each(n,function(a){"undefined"!=typeof t[a]&&0==t[a].length&&e.errors.push(a)}),3==t.type&&(t.dept="[校友]"+t.dept,t.addr=t.addr+" 就读时间:"+t.st_year+"/"+t.st_month+" ~ "+t.gra_year+"/"+t.gra_month,delete t.st_year,delete t.st_month,delete t.gra_year,delete t.gra_month),4==t.type&&(t.realname=t.realname+t.stu_num,t.dept="[2017新生通道]"+t.dept,delete t.stu_num),2==t.type&&(t.qids=[0,1]),3==t.type&&(t.qids=[2,3,4]),4==t.type&&(t.qids=[5,6]),5==t.type&&(t.qids=[7]),t.qids&&(t.qids=JSON.stringify(t.qids)),delete t.captcha,e.errors.length>0&&(e.success=!1),e.data=t,e}function s(t){$(".form-content").slideUp(),$('[data-role="success-username"]').text(t.username),1==t.type||6==t.type?($('[data-role="success-mail-link"]').attr("href",0==t.emailsuf.indexOf("mail")?"http://"+t.emailsuf:"http://mail."+t.emailsuf).text(t.email+"@"+t.emailsuf),$(".success-content").eq(0).slideDown()):$(".success-content").eq(1).slideDown()}BDWM.init("#page-register",function(){t(),e(),a(),i(),o()});var c,d}(),function(){function t(){o=0,r=!1}function e(){$('[data-action="clear-form"]').click(function(){$(this).closest(".form").find("input[type=text]").val("")})}function a(){$('[data-action="submit-form"]').click(function(){if(r)return!1;var t=$(this).closest(".form"),e=t.data("path"),a={};t.find("input[type=text], input[type=hidden], input[type=password], input[type=tel], input[type=number], input[type=email], select, input[type=radio]:checked, input[type=checkbox]").each(function(){"checkbox"!=$(this).attr("type")?a[$(this).data("role")]=$(this).val():a[$(this).data("role")]=$(this).prop("checked")?1:0});var o=n(a);return t.find(".row").removeClass("warning warning-custom"),o.success?(r=!0,void(1==a.type?$.ajax({type:"POST",url:"ajax/get_userinfo_by_names.php",data:{names:JSON.stringify([o.data.username])},dataType:"json",timeout:4e3}).done(function(a){a.success?0==a.result.length||0==a.result[0]?(BDWM.alert({text:"该用户不存在"}),r=!1):$.ajax({type:"POST",url:e,data:{uid:a.result[0].id},dataType:"json",timeout:1e4}).done(function(e){e.success?i(o.data):11==e.error?t.find('[data-role="username"]').focus().closest(".row").addClass("warning-custom").find(".warning-info-custom").text("该用户注册时并未绑定邮箱"):BDWM.alert({text:"请求失败，错误码: "+e.error}),r=!1}).fail(function(){BDWM.alert({text:"网络错误,请稍后再试",timeout:3e3}),r=!1}):(BDWM.alert({text:"网络错误，请稍后重试",timeout:3e3}),r=!1)}).fail(function(){BDWM.alert({text:"网络错误,请稍后再试",timeout:3e3}),r=!1}):11==a.type&&$.ajax({type:"POST",url:e,data:o.data,dataType:"json",timeout:1e4}).done(function(t){t.success?i(o.data):38==t.error?BDWM.alert({text:"新密码不符合强度要求"}):BDWM.alert({text:"请求失败，错误码: "+t.error}),r=!1}).fail(function(){BDWM.alert({text:"网络错误,请稍后再试",timeout:3e3}),r=!1}))):(_.each(o.errors,function(e,a){t.find('[data-role="'+e+'"]').closest(".row").addClass("warning"),0==a&&t.find('[data-role="'+e+'"]').focus()}),!1)})}function n(t){var e={success:!0,errors:[]};return"undefined"!=typeof t.username&&(t.username.match(/^[A-Za-z]{2,12}$/)||e.errors.push("username")),"undefined"!=typeof t.password&&t.password.length<8&&e.errors.push("password"),"undefined"!=typeof t.password_repeat&&(t.password_repeat!=t.password&&e.errors.push("password_repeat"),delete t.password_repeat),e.errors.length>0&&(e.success=!1),e.data=t,e}function i(t){$(".form-content").slideUp(),$('[data-role="success-username"]').text(t.username),$(".success-content").eq(0).slideDown()}BDWM.init("#page-reset-password",function(){t(),e(),a()});var o,r}(),function(){function t(){}function e(){$('.search-header .types >a[data-action="search-type"]').click(function(){var t=$(this),e=t.hasClass("active");t.siblings().removeClass("active"),t.addClass("active"),"post"!=t.data("type")?(n(!1),$('[data-action="advanced-search-toggle"]').hide()):$('[data-action="advanced-search-toggle"]').show(),t.closest(".search-header").find(".instructions >span").removeClass("active").eq(t.index()).addClass("active"),$('#search-form input[name="mode"]').val(t.data("type")),e||$("#search-form").submit()})}function a(){$('[data-action="advanced-search-toggle"]').click(function(){var t=$(this);n(!t.attr("data-shown"))}),$("#advanced-search input[maxlength]").each(function(){BDWM.inputLimit(this)}),$('#advanced-search [data-action="submit-advanced-search"]').click(function(){var t=parseInt($('#advanced-search [name="days"]').val());if(isNaN(t)||t<0||t>366)return BDWM.alert({text:"输入天数不合法"}),!1;var e=$('#advanced-search [name="board"]').val();e&&e.toString().length>0?i(e,function(t){$('#advanced-search [name="bid"]').val(t),$("#search-form-advanced").submit()}):$("#search-form-advanced").submit()})}function n(t){var e=$('[data-action="advanced-search-toggle"]');t?($("#search-result").hide(),$("#advanced-search").show(),e.text("收起"),e.attr("data-shown","true")):($("#search-result").show(),$("#advanced-search").hide(),e.text("高级搜索"),e.removeAttr("data-shown"))}function i(t,e){$.ajax({type:"POST",url:"ajax/get_topsearch.php",data:{pref:t},dataType:"json"}).done(function(a){if(a.success)if(1==a.boards.length)e(a.boards[0].id);else if(a.boards.length>1){var n=_.find(a.boards,function(e){return e.name.toLowerCase()==t.toLowerCase()});n?e(n.id):BDWM.alert({text:"该版面不存在,请检查",timeout:2e3})}else BDWM.alert({text:"该版面不存在,请检查",timeout:2e3});else BDWM.alert({text:"服务器提出了一个错误,我们正在修复",timeout:2e3})}).fail(function(){BDWM.alert({text:"网络错误,请稍后再试",timeout:2e3})})}BDWM.init("#page-search",function(){t(),e(),a()})}(),function(){function t(){h=$("#input-sa"),y=[],k=$(".list-item .input-wrapper :checkbox"),m=parseInt($("#bid").attr("data-bid"))}function e(){var t=$("#change-list-mode").attr("data-mode");return t="topic"===t?"topic":"single"}function a(t,a,n){var i=["highlight","unhighlight","top","untop","mark","unmark","digest","undigest","recover_top","score"];return _.isArray(a)||(a=[parseInt(a)]),_.contains(i,n)||"single"===e()?$.ajax({type:"POST",url:v,data:{bid:t,list:JSON.stringify(a),action:n},dataType:"json"}):$.ajax({type:"POST",url:g,data:{bid:t,list:JSON.stringify(a),action:n},dataType:"json"})}function n(t,e,a,n){return $.ajax({type:"POST",url:v,data:{bid:t,list:JSON.stringify([parseInt(e)]),action:a,rating:n},dataType:"json"})}function i(t,e){return $.ajax({type:"POST",url:b,data:{bid:t,content:e},dataType:"json"})}function o(t,e){return $.ajax({type:"POST",url:w,data:{bid:t,content:e},dataType:"json"})}function r(t,e){return $.ajax({type:"POST",url:x,data:{bid:t,threadid:e},dataType:"json"})}function s(){y=[],k.each(function(){if(this.checked){var t=$(this).closest(".list-item");y.push(parseInt(t.data("itemid")))}}),$.isEmptyObject(y)?$(".option-button-group").removeClass("show"):$(".option-button-group").addClass("show")}function c(){$("#list-content .list-item").each(function(t){$(this).css({position:"relative","z-index":60-t})})}function d(){k.prop("checked",!1),k.click(function(){this.checked||h.prop("checked",!1),s()})}function l(){$(".intro-edit-button").click(function(){var t=$(".intro-content").text();"请用一句话介绍本版面"==t&&(t=""),$(".intro-edit").val(t),$(".intro-content").removeClass("show"),$(".intro-edit-button").removeClass("show"),$(".intro-edit").addClass("show"),$(".intro-save-button").addClass("show"),$(".intro-cancel-button").addClass("show")}),$(".intro-save-button").click(function(){var t=$(".intro-edit").val();i(m,t).done(function(e){e.success?($(".intro-edit").removeClass("show"),$(".intro-save-button").removeClass("show"),$(".intro-cancel-button").removeClass("show"),$(".intro-edit-button").addClass("show"),""==t&&(t="请用一句话介绍本版面"),$(".intro-content").text(t),$(".intro-content").addClass("show")):BDWM.alert({text:"编辑失败~请稍后重试",timeout:2e3})}).fail(function(){BDWM.alert({text:"网络错误~请稍后重试",timeout:2e3})})}),$(".intro-cancel-button").click(function(){$(".intro-edit").removeClass("show"),$(".intro-save-button").removeClass("show"),$(".intro-cancel-button").removeClass("show"),$(".intro-edit-button").addClass("show"),$(".intro-content").addClass("show")})}function u(){var t=$(this),e=t.data("itemid");t.find('[data-action="score"]').removeClass("hover"),t.find('[data-action="score"]').hover(function(){$(this).prevAll().addClass("hover"),$(this).nextAll().removeClass("hover"),$(this).addClass("hover")}).click(function(){var t=$(this).data("score");BDWM.confirm({text:"给帖子打上原创分后，你将没有权限修改分数。<br>是否给这篇帖子打上原创分"+t+"分",callback:function(a){a&&n(m,e,"rate",t).done(function(t){t.results&&0==t.results[0]?BDWM.reload():BDWM.alert({text:"打原创分失败~请稍后重试",timeout:2e3})}).fail(function(){BDWM.alert({text:"网络错误~请稍后重试",timeout:2e3})})}})}),t.find(".thread-topic-collect").click(function(){BDWM.confirm({text:"是否确定在版面生成本主题帖的合集",callback:function(t){t&&r(m,e).done(function(t){t.success?BDWM.reload():BDWM.alert({text:"合集失败~请稍后重试",timeout:2e3})}).fail(function(){BDWM.alert({text:"网络错误~请稍后重试",timeout:2e3})})}})});var i=[{path:".thread-single-del",action:"delete",name:"删除",confirm:"是否确定删除帖子"},{path:".thread-single-set-gl",action:"highlight",name:"高亮"},{path:".thread-single-set-zdgl",action:"highlight_top",name:"设置置顶高亮"},{path:".thread-single-set-wz",action:"digest",name:"设置文摘"},{path:".thread-single-set-zd",action:"top",name:"置顶"},{path:".thread-single-set-bl",action:"mark",name:"保留"},{path:".thread-single-set-wzbl",action:"mark_digest",name:"设置文摘区保留"},{path:".thread-single-set-re",action:"noreply",name:"设置不可re"},{path:".thread-single-unset-gl",action:"unhighlight",name:"取消高亮"},{path:".thread-single-unset-zdgl",action:"unhighlight_top",name:"取消置顶高亮"},{path:".thread-single-unset-wz",action:"undigest",name:"取消文摘"},{path:".thread-single-unset-zd",action:"untop",name:"取消置顶",confirm:"是否取消置顶"},{path:".thread-single-unset-bl",action:"unmark",name:"取消保留"},{path:".thread-single-unset-wzbl",action:"unmark_digest",name:"取消文摘区保留"},{path:".thread-single-unset-re",action:"unnoreply",name:"取消不可re"},{path:".thread-topic-set-re",action:"noreply",name:"设置不可re"},{path:".thread-topic-del",action:"delete",name:"删除",confirm:"是否确定删除帖子"},{path:".thread-topic-unset-re",action:"unnoreply",name:"取消不可re"}];_.each(i,function(n){t.find(n.path).click(function(){var t=function(){a(m,e,n.action).done(function(t){t.results&&_.contains(t.results,!1)?BDWM.reload():BDWM.alert({text:n.name+"失败~请稍后重试",timeout:2e3})}).fail(function(){BDWM.alert({text:"网络错误~请稍后重试",timeout:2e3})})};n.confirm?BDWM.confirm({text:n.confirm,callback:function(e){e&&t()}}):t()})})}function f(){h.prop("checked",!1),h.click(function(){k.prop("checked",this.checked),s()});var t=[{path:"#thread-set-pin",action:"top",name:"置顶"},{path:"#thread-set-bl",action:"mark",name:"设置保留"},{path:"#thread-set-wz",action:"digest",name:"设置文摘"},{path:"#thread-set-gl",action:"highlight",name:"高亮"},{path:"#thread-set-lock",action:"noreply",name:"设置不可re"},{path:"#thread-delete",action:"delete",name:"删除",confirm:"是否确定删除帖子"}];_.each(t,function(t){$(t.path).click(function(){var e=function(){a(m,y,t.action).done(function(e){e.results&&0==e.results[0]?BDWM.reload():BDWM.alert({text:t.name+"失败~请稍后重试",timeout:2e3})}).fail(function(){BDWM.alert({text:"网络错误~请稍后重试",timeout:2e3})})};t.confirm?BDWM.confirm({text:t.confirm,callback:function(t){t&&e()}}):e()})})}function p(){var t=null;$(".note-foot .edit").click(function(){var e=$("#note-content").html();t=$("#note-content-edit").bdwm_editor()[0],t.inject(e),$("#note-content-edit").addClass("show"),$('[data-action="insertimage"]').hide(),$(".note-foot .edit").removeClass("show"),$(".note-foot .save").addClass("show"),$(".note-foot .cancel").addClass("show"),$("#note-content").hide()});var e=function(){$(".note-foot .edit").addClass("show"),$(".note-foot .save").removeClass("show"),$(".note-foot .cancel").removeClass("show"),$("#note-content").show();var t=$("#note-content-edit");t.removeClass("show"),console.log(t),t.parent().hasClass("qeditor_border")&&t.siblings().remove()};$(".note-foot .save").click(function(){var e=t.toStruct();o(m,JSON.stringify(e)).done(function(t){t.success?BDWM.reload():BDWM.alert({text:"修改失败",timeout:2e3})}).fail(function(){BDWM.alert({text:"网络错误,请稍后再试.",timeout:2e3})})}),$(".note-foot .cancel").click(function(){e()})}BDWM.init("#page-thread-opt, #page-note",function(){t(),c(),d(),l(),$(".list-item").each(u),f(),p()}.bind(this));var h,m,v="ajax/operate_post.php",g="ajax/operate_thread.php",b="ajax/set_board_desc.php",w="ajax/set_board_note.php",x="ajax/create_thread_collect.php",y=[],k=[]}.call(this),function(){function t(){W=!1,B=[],M=[],j="",w=!1}function e(){B=[],$("#list-content .list-item-topic").each(function(){B.push({id:parseInt($(this).attr("data-itemid"))})}),$("#list-content .list-item-single").each(function(){B.push({id:parseInt($(this).attr("data-itemid"))})})}function a(){$('[data-action="make-favorite"]').click(function(t){if(t.stopPropagation(),t.preventDefault(),!W){var e=$('a[data-action="make-favorite"]');e.hasClass("active")?n(p(),!1).done(function(t){if(t.success){var a=$("#add-fav .num");a.text(parseInt(a.text())-1),$("#fav-text").text("收藏本版"),e.removeClass("active")}}):(W=!0,n(p(),!0).done(function(t){if(t.success){var a=$("#add-fav .num");a.text(parseInt(a.text())+1),$("#fav-text").text("已收藏"),h("favorite-modal"),e.addClass("active"),W=!1}}))}})}function n(t,e){return $.ajax({type:"POST",url:k,data:{action:e?"add":"delete",bids:JSON.stringify([parseInt(t)])},dataType:"json"})}function i(){$("#goto-input").bind("change keyup",o)}function o(){var t=$("#goto-input"),e=t.val(),a=$("#goto-link");(isNaN(e)||e<=0||!/^\d+$/.test(e))&&(t.val(""),e=1);var n=g();a.attr("href","?bid="+p()+(1==n?"&mode="+v():"&type="+n)+(1==e?"":"&page="+e))}function r(){var t=$("#more-button"),e=$(".hidden");t.click(function(a){a.stopPropagation(),a.preventDefault(),$(this).hasClass("active")?(e.css("display","none"),$(this).html("更多  &#9658"),$(t).removeClass("active")):(e.css("display","inline-block"),$(this).html("&#9668"),$(t).addClass("active"))}),t.click()}function s(){$("#list-content .list-item-topic .link, #list-content .list-item-single .link").click(function(){var t=$(this).closest(".list-item-topic, .list-item-single");c(t)}),$("#clear-all-unread").click(function(){l()})}function c(t){var e=$(t).find(".dot");return!!e.size()&&($(t).find(".dot").removeClass("unread"),!0)}function d(t,e){return"single"===v()?$.ajax({type:"POST",url:y,data:{bid:t,list:JSON.stringify(e)},dataType:"json"}):$.ajax({type:"POST",url:x,data:{bid:t,list:JSON.stringify(e)},dataType:"json"})}function l(){d(p(),_.pluck(B,"id")).done(function(t){t.success?$("#list-content").find(".dot").removeClass("unread"):console.log(t)}).fail(function(){console.log("clear all unread failed.")})}function u(t,e){return _.isArray(e)||(e=[parseInt(e)]),$.ajax({type:"POST",url:D,data:{bid:t,list:JSON.stringify(e),action:"recover"},dataType:"json"})}function f(){var t=$(this),e=t.data("itemid");t.find(".putback").click(function(){BDWM.confirm({text:"是否确定将本帖放回原处",callback:function(t){t&&u(p(),e).done(function(t){t.success?BDWM.reload():BDWM.alert({text:"放回失败~请稍后重试",timeout:2e3})}).fail(function(){BDWM.alert({text:"网络错误~请稍后重试",timeout:2e3})})}})})}function p(){return parseInt($("#bid").attr("data-bid"))}function h(t){$("#"+t).bdwm_dialog().show()}function m(){$("#change-list-mode").click(function(t){t.preventDefault();var e="single"===v()?"topic":"single";if(BDWM.setCookie("mode",e),BDWM.storage.set("mode",e),window.location.pathname&&window.location.search){var a=window.location.pathname+window.location.search.replace("&mode=single","").replace("&mode=topic","")+"&mode="+e;BDWM.redirect(a)}else BDWM.reload()})}function v(){var t=$("#change-list-mode").attr("data-mode");return t="single"===t?"single":"topic"}function g(){return $("#list-filter").attr("data-type")}function b(t){t.find('[data-role="input-anonymous"]').change(function(){var t=$(this);t.prop("checked")?(t.closest(".bdwm-editor").find('[data-role="signature"]').attr("data-signature-no-history","true"),t.closest(".bdwm-editor").find('[data-option][data-value=""]').click().closest(".cs-select").removeClass("cs-active")):t.closest(".bdwm-editor").find('[data-role="signature"]').removeAttr("data-signature-no-history")}),t.find('[data-role="new-post-textarea"]').keydown(function(e){return 13!=e.keyCode||!e.metaKey&&!e.ctrlKey||(t.find('[data-action="new-post-publish"]').click(),!1)}),t.find('[data-action="new-post-publish"]').click(function(){if(w)return!1;if($(this).attr("disabled"))return!1;var e=t.find('[data-role="new-post-textarea"]').val();if(!e||0==e.length)return BDWM.alert({text:"内容不可为空"}),!1;var a=t.data("bid"),n=t.find('[data-role="post-title"]').val();if(0==n.length)return void BDWM.alert({text:"标题不可为空"});var i=[$.extend(!0,{},BDWM.defaultStyle,{content:e+"\n"})],o={title:n,content:JSON.stringify(i),bid:a,postinfo:{}};!t.find('[data-role="input-anonymous"]').prop("disabled")&&t.find('[data-role="input-anonymous"]').prop("checked")&&(o.postinfo.anony=!0);var r=BDWM.storage.get("preference-subscribe-reply",!0);o.postinfo.anony||"true"!=r&&1!=r||(o.postinfo.mail_re=!0);var s=t.find('[data-role="signature"]').val();if("random"==s){var c=parseInt(t.find('[data-role="signature"]').data("signature-count"));s=Math.floor(c*Math.random())%c,o.signature=s}else""!=s&&(o.signature=parseInt(s),isNaN(o.signature)&&(o.signature=""));o.postinfo=JSON.stringify(o.postinfo);var d=function(t){"topic"==BDWM.getCookie("mode")?BDWM.redirect("post-read.php?bid="+a+"&page=a&threadid="+t.result.threadid+"&postid="+t.result.postid+"#"+t.result.postid):BDWM.redirect("post-read-single.php?bid="+a+"&postid="+t.result.postid)};w=!0,$.ajax({type:"POST",url:"ajax/create_post.php",data:o,dataType:"json",timeout:1e4}).done(function(t){w=!1,t.success?d(t):BDWM.alert({text:"发布失败，请稍后重试"})}).fail(function(){w=!1,BDWM.alert({text:"网络错误，请稍后重试"})})})}BDWM.init(".page-thread",function(){t(),e(),a(),i(),r(),s(),m(),$(".list-item").each(f),b($("#bdwm-editor"))}.bind(this));var w,x="ajax/set_thread_read.php",y="ajax/set_post_read.php",k="ajax/set_good_boards.php",D="ajax/operate_post.php",M=[],W=!1,B=[],j=""}.call(this),function(t,e){function a(){var e=t("#page-settings");if(e.hasClass("refill-form")){var a=parseInt(e.data("type")),n=t("ul.tabs > li");n.each(function(a){var i=t(this);i.click(function(){"undefined"==typeof i.attr("disabled")&&(e.find("form").hide(),e.find("form:eq("+a+")").show(),n.removeClass("active"),i.addClass("active"))})}).eq(a-1).click()}}function n(){if(t("#page-settings").hasClass("preference")){t("[data-inlocalstorage]").each(function(){BDWM.storage.get("preference-"+this.name)==this.value&&(this.checked=!0)});var e=t("#preference-form");e.find("button[type=submit]").click(function(){e.find("[data-inlocalstorage]:checked").each(function(){BDWM.storage.set("preference-"+this.name,this.value)})})}}function i(){return ua&&"ie"==ua.browser.family.toLowerCase()}function o(e){1==e?(t(".avatar-step-1").show().find(".avatar-upload").next().text("上传本地图片"),
    t(".avatar-step-2").hide()):(t(".avatar-step-1").hide(),t(".avatar-step-2").show())}function r(){var e=0;t("#page-settings label").each(function(){var a=t(this),n=a.find("input"),i=a.find("span").html();if(0!=n.length){var o="__autoInput"+e++;n.prop("id",o).addClass("styledbox"),a.prop("for",o).addClass("styledbox"),a.before(n),a.html(i)}})}function s(){var e=60;t("select.cs-select").each(function(){var a=t(this),n=a.parent();BDWM.initSelect(this);var i=n.find("> *");a.hasClass("enlarged")&&i.addClass("enlarged"),i.css("zIndex",e--)})}function c(){var e=t("#ssh-key").change(function(){var a=t(this),n=a.clone(!0);e.find("span").text("正在上传"),BDWM.file_upload(this,"ajax/set_ssh_pubkey.php","",x,x,function(t,a,i){return i=i||{},e.prepend(n),e.find("span").text("上传"),i.success?BDWM.alert({html:"SSH Pubkey 已经上传并保存成功。",widthAuto:!0}):BDWM.alert({html:"SSH Pubkey 上传失败，请稍后再试。",widthAuto:!0})})}).parent()}function d(){try{b=t("#page-settings").data("trait").split(/\s+/)}catch(a){b=[]}t("#avatar-crop-confirm").click(function(){t.post("ajax/upload_avatar.php",{action:"finish",name:g,rect:JSON.stringify(k)},function(t){return BDWM.alert({html:"头像修改成功！",widthAuto:!0,callback:function(){location.reload(!0)},timeout:4e3})},"json")}),t("#avatar-crop-cancel").click(o.bind(null,1)),t("#avatar-return").click(function(){history.back(),setTimeout(BDWM.reload,1e3)}),t("[data-fill-role=src]").change(function(){var e=t(this);t("[data-fill="+e.data("fill")+"][data-fill-role=dest]").text(e.find("option:selected").data(e.data("fill-field")))}).change(),t("form[data-ajaxsubmit]").submit(function(a){var n=t(this),o={},r=e;if(n.find("[data-ensureequal]").each(function(){var e=t(this).data("ensureequal");if(e in o){if(this.value!=o[e])return r=e}else o[e]=this.value}),r)return BDWM.alert({text:r+"不同，请检查。"}),!1;var s={};$&&(i()?s.desc=JSON.stringify([t.extend(!0,{},BDWM.defaultStyle,{content:$.val()+"\n"})]):s.desc=JSON.stringify($.toStruct()));var c=n.prop("method").toLowerCase(),d=n.prop("action"),l=n.data("actiontext"),u=n.data("then"),f=_.extend(n.serializeObject(),s);n.find("[name]").removeClass("invalid");var p=function(t){return n.find("[name='"+t+"']").addClass("invalid"),null},h=!0;return b.forEach(function(t){if(y[t]instanceof Function){var e=y[t](f,p);e?f=e:h=!1}}),h&&t[c](d,f,function(t){t.success?BDWM.alert({text:"设置安全邮箱"==l?"验证邮件已发送，请点击邮件链接进行验证":l+"成功！",timeout:5e3,callback:u?BDWM.redirect.bind(BDWM,u):function(){}}):5==t.error?BDWM.alert({text:"输入密码错误"}):38==t.error?BDWM.alert({text:"新密码过于简单，修改失败"}):BDWM.alert({text:l+"失败，请稍后再试……"})},"json").fail(function(){BDWM.alert({text:l+"失败，请稍后再试……"})}),a.preventDefault(),!1})}function l(){var e=t("#page-settings .avatar-step-1"),a=e.find(".avatar-upload").change(function(){var t=this.value.toLowerCase();if(!w.some(function(e){return t.endsWith(e)}))return BDWM.alert({html:"抱歉，本站当前仅支持属于 jpg，png，tiff 格式，<br />且在 2MB 以下的头像",widthAuto:!0});var e=a.next().text("请稍候").parent(),n=a.clone(!0);BDWM.file_upload(this,"ajax/upload_avatar.php","action=upload",x,x,function(t,i,r){return r=r||{},g=r.name,v=r.addr,g&&v?void u(v,function(){e.prepend(a=n),o(2)}):(e.prepend(a=n),BDWM.alert({html:"头像上传出现错误，请稍后重试。",widthAuto:!0}))})})}function u(e,a){function n(){function t(t,e){e>h-v-y?e=h-v-y:e<y&&(e=y),t>p-m-x?t=p-m-x:t<x&&(t=x),r.css({top:t+"px",left:e+"px",backgroundPosition:"-"+(e-y)+"px -"+(t-x)+"px"}),$=t,g=e;var a=(e-y)*i,n=(t-x)*i;k.x=Math.ceil(_=a),k.y=Math.ceil(j=n),s.css({backgroundPosition:"-"+a/w+"px -"+n/w+"px"})}function e(t,e){var a=Math.min(Math.max(t,e,10),h-g-y,p-$-x);r.css({height:a,width:a}),w=a/n,m=v=a,k.height=k.width=Math.floor(a*i),s.css({backgroundSize:f/w+"px "+u/w+"px",backgroundPosition:"-"+_/w+"px -"+j/w+"px"})}var n,i,l=o.height/o.width,u=o.height,f=o.width,p=c.height(),h=c.width(),m=r.height(),v=r.width(),g=0,$=0,b=p/h,w=1;b>l?(i=o.width/h,o.width=h,o.height=o.width*l):(i=o.height/p,o.height=p,o.width=o.height/l);var x=(p-o.height)/2,y=(h-o.width)/2,D=!1,M=!1;r.css({height:(m/=i)+"px",width:(v/=i)+"px",backgroundSize:o.width+"px "+o.height+"px",backgroundPosition:"-"+(h/2-y)+"px -"+(p/2-x)+"px",top:p/2+"px",left:h/2+"px"}),n=m;var W,B,_=0,j=0;d.mousedown(function(t){return t.stopPropagation(),M=!0,B=r.offset(),!1}),c.off("mousedown mousemove mouseup").mousedown(function(t){D=!0,W=c.offset()}).mousemove(function(a){if(D){var n=a.pageY-W.top-m/2,i=a.pageX-W.left-v/2;t(n,i)}if(M){var o=a.pageY-B.top,r=a.pageX-B.left;e(r,o)}}).mouseup(function(){D=M=!1}),e(220,220),t(0,0),e(220,220),t(0,0),a()}var i=t("#page-settings .avatar-step-2");if(0!=i.length){var o=document.getElementById("original-image"),r=i.find("#avatar-selector").removeProp("style"),s=i.find("#avatar-preview").removeProp("style"),c=i.find(".image-cropper"),d=i.find(".handle");o.removeAttribute("height"),o.removeAttribute("width"),o.src=e,o.onload=n,s.css("background-image","url("+e+")"),r.css("background-image","url("+e+")")}}function f(){if(t("#desc-textarea").length>0){i()?$=t("#desc-textarea"):($=t("#desc-textarea").bdwm_editor({})[0],t("#desc-textarea").data("editor",$));var e=t(t("#desc-textarea").data("origin"));if(i()){var a="";_.each(BDWM.parser(e),function(t){a+="quotehead"==t.type?t.username+"("+t.nickname+")"+t.mail?"在来信中提到":"在 ta 的大作中提到\n":t.content||""}),$.val(a),e.remove()}else!e||0==e.length||0==e.text().length&&0==e.find("img").length?(e="<p><br></p>",$.inject(e)):($.injectObject(e),e.remove())}else $=null}function p(){var e=t("#page-settings"),a=e.find(".signature:not(.template)").length;e.find(".signature:not(.template)").each(function(){var e,a=t(this).find("textarea");e=i()?a:a.bdwm_editor({})[0],a.data("editor",e);var n=t(a.data("origin"));if(i()){var o="";_.each(BDWM.parser(n),function(t){o+="quotehead"==t.type?t.username+"("+t.nickname+")"+t.mail?"在来信中提到":"在 ta 的大作中提到\n":t.content||""}),e.val(o),n.remove()}else!n||0==n.length||0==n.text().length&&0==n.find("img").length?(n="<p><br></p>",e.inject(n)):(e.injectObject(n),n.remove())}),e.find(".signature .del-btn").click(function(){t(this).closest(".signature").slideUp(function(){t(this).remove(),e.find(".signature").each(function(e){t(this).find("h2").text("第"+e+"个")}),a--})});var n=e.find(".signature.template").clone(!0);n.removeClass("template").attr("style","").find("input, textarea").val(""),e.find("#btn-new-signature").click(function(){if(!(a>=20)){var t=n.clone(!0);t.find("h2").text("第"+(a+1)+"个"),e.find(".insert-signature-before").before(t),i()?t.find("textarea").data("editor",t.find("textarea")):t.find("textarea").data("editor",t.find("textarea").bdwm_editor({})[0]),a++}})}function h(){var e=!1;t('[data-action="submit-signatures"]').click(function(a){a.preventDefault(),a.stopPropagation();var n=!0;if(e)return!1;var o=t("#page-settings"),r=[];return o.find(".signature:not(.template)").each(function(e){var a={},o=t(this).find("textarea").data("editor");if(a.desc=t(this).find('input[name="desc"]').val(),i())a.content=[t.extend(!0,{},BDWM.defaultStyle,{content:o.val()+"\n"})];else{if(a.content=o.toStruct(),o.lineCount()>6)return BDWM.alert({text:"修改失败,第"+(e+1)+"个签名档超过6行"}),n=!1,!1;if(o.getText().length>500)return BDWM.alert({text:"修改失败,第"+(e+1)+"个签名档超过500字"}),n=!1,!1;if(_.filter(a.content,function(t){return"img"==t.type}).length>1)return BDWM.alert({text:"修改失败,第"+(e+1)+"个签名档图片超过1个"}),n=!1,!1}r.push(a)}),!!n&&(r={signatures:JSON.stringify(r)},e=!0,t.ajax({type:"POST",url:"ajax/set_signatures.php",data:r,dataType:"json",timeout:4e3}).done(function(t){e=!1,t.success?BDWM.alert({text:"修改成功"}):BDWM.alert({text:"修改失败"})}).fail(function(){e=!1,BDWM.alert({text:"网络错误，请稍后重试"})}),!1)})}function m(){t('[data-action="blog-import"]').click(function(){t.ajax({type:"POST",url:"ajax/import_blog.php",dataType:"json",timeout:4e3}).done(function(t){t.success?BDWM.alert({text:"转换已经开始，结果将通过站内信通知您"}):BDWM.alert({text:t.reason})}).fail(function(){BDWM.alert({text:"网络错误，请稍后重试"})})})}jQuery.fn.serializeObject=function(){var a={},n=this.serializeArray();return t.each(n,function(){a[this.name]!==e?(a[this.name].push||(a[this.name]=[a[this.name]]),a[this.name].push(this.value||"")):a[this.name]=this.value||""}),a},String.prototype.endsWith||(String.prototype.endsWith=function(t,e){var a=this.toString();("number"!=typeof e||!isFinite(e)||Math.floor(e)!==e||e>a.length)&&(e=a.length),e-=t.length;var n=a.indexOf(t,e);return n!==-1&&n===e});var v,g,$,b,w=[".jpg",".jpeg",".png",".tiff"],x=function(){},y={"refill-form":function(t,e){if("undefined"!=typeof t.email){if(1==t.type&&!t.email.match(/^[0-9]{5}([0-9]{3}([0-9]{2})?)?$/))return e("email"),!1;if(6==t.type){if(!t.email||!t.emailsuf)return e("email"),!1;if(t.emailsuf.indexOf("ruc")>=0){if(!t.email||!t.email.match(/^20[0-9]{8}$/))return e("email"),!1}else if(!t.email||!t.email.match(/^[A-Za-z0-9][A-Za-z0-9-_.]*$/))return e("email"),!1}}return 3==t.type&&(t.dept="[校友]"+t.dept,t.addr=t.addr+" 就读时间:"+t.st_year+"/"+t.st_month+" ~ "+t.gra_year+"/"+t.gra_month,delete t.st_year,delete t.st_month,delete t.gra_year,delete t.gra_month),4==t.type&&(t.realname=t.realname+t.stu_num,t.dept="[2017新生通道]"+t.dept,delete t.stu_num),2==t.type&&(t.qids=[0,1]),3==t.type&&(t.qids=[2,3,4]),4==t.type&&(t.qids=[5,6]),5==t.type&&(t.qids=[7]),t.qids&&(t.qids=JSON.stringify(t.qids)),delete t.type,t},"modify-password":function(t,e){return t.newpass.length<8||t.newpass.replace(/[^\x00-\xff]/g,"aa").length>60?(e("newpass"),!1):t}},k={x:0,y:0,width:100,height:100};BDWM.init("#page-settings",function(){n(),s(),a(),d(),l(),o(1),f(),p(),h(),r(),m(),c()})}(jQuery),function(){function t(){$('[data-action="show-operation-list"]').click(function(t){t.stopPropagation(),$(this).closest(".btns").find(".operations").css({top:$(this).parent().position().top+7,left:$(this).parent().position().left}).show()}),$("body").click(function(t){$("#page-user .operations").hide()})}function e(){$(".icon-btn.disabled, .operations-button.disabled-gray").click(function(){BDWM.dialogWithCloseIcon($("<span>您尚未登录，无法使用此功能</span>"))})}BDWM.init("#page-user",function(){t(),e()})}(),function(){function t(){c="ajax/operate_vote.php"}function e(t,e){return $.ajax({type:"POST",url:c,data:{bid:t,vid:e,action:"end"},dataType:"json",timeout:4e3})}function a(t,e){return $.ajax({type:"POST",url:c,data:{bid:t,vid:e,action:"delete"},dataType:"json",timeout:4e3})}function n(){$("#vote .list-item a.link, #vote-opt .list-item a.link").click(function(t){t.preventDefault();var e=$(this).closest(".list-item");e.hasClass("active")?(e.removeClass("active"),e.nextUntil(".list-item").slideUp()):(e.addClass("active"),e.nextUntil(".list-item").slideDown())})}function i(){var t=239;$(".vote-body").each(function(){var e=$(this),a=parseInt(e.data("type"));if(3==a){var n=parseInt(e.data("max-tickets"));e.find('input[type="checkbox"]').change(function(){e.find('input[type="checkbox"]:checked').length>n&&$(this).attr("checked",!1)})}e.find("textarea").bind("propertychange input",function(){for(var a=$(this).val();a.split("\n").length>3;){var n=a.lastIndexOf("\n");a=n==a.length-1?a.substr(0,n):a.substr(0,n)+a.substr(n+1)}for(;a.replace(/[^\x00-\xff]/g,"**").length>t;)a=a.substr(0,a.length-1);$(this).val(a),e.find("label.bottom-right").text(a.replace(/[^\x00-\xff]/g,"**").length+" / "+t)})})}function o(){function t(t){$("#"+t).bdwm_dialog().show()}var e=!1,a=function(t){return $.ajax({type:"POST",url:"ajax/set_ballot.php",data:t,dataType:"json",timeout:4e3})},n=function(){var t={},e=$(this).closest(".vote-body"),a=parseInt(e.data("vid")),n=parseInt(e.data("type"));if(t.vid=a,t.bid=e.data("bid"),n<=3){var i=0;if(e.find('input[name="choice"]:checked').each(function(){var t=$(this);i|=1<<t.closest("p").index()-1}),0==i)return!1;t.optmask=i}return!(4==n&&(t.value=parseInt(e.find('input[name="value"]').val()),!t.value))&&(t.comment=e.find("textarea").val(),!!(5!=n||t.comment&&""!=t.comment)&&t)},i=function(){$(this).closest(".vote-body").find("input").removeAttr("checked").val(""),$(this).closest(".vote-body").find("textarea").val("")},o=function(t){var e=$('.vote-body[data-vid="'+t+'"]'),a=$('.list-item[data-vid="'+t+'"]');e.data("voted")||(e.data("voted",!0),e.find('.buttons .button[data-action="submit-vote"]').text("修改"),a.find(".title").addClass("read").append("<span>已参与</span>"),a.find(".num").text(parseInt(a.find(".num").text())+1))};$('[data-action="clear-vote"]').click(i),$('[data-action="submit-vote"]').click(function(){if(!e){var i=n.bind(this)();i?(e=!0,a(i).done(function(a){e=!1,a.success?(t("vote-success-modal"),o(i.vid)):t("vote-fail-modal")}).fail(function(){e=!1,t("vote-fail-modal")})):t("vote-check-fail-modal")}})}function r(){$('[data-action="end-vote"]').click(function(){if(!d){var t=$(this).closest(".list-item"),a=t.data("vid"),n=t.data("bid"),i=t.data("title");BDWM.confirm({text:"<span>当前操作不可撤销，是否确认提前结束投票</span><br><span>"+i+"</span>",callback:function(t){t&&(d=!0,e(n,a).done(function(t){d=!1,t.success?BDWM.reload():BDWM.alert({text:"操作失败>.<"})}).fail(function(){d=!1,BDWM.alert({text:"网络超时辣>.<"})}))}})}}),$('[data-action="delete-vote"]').click(function(){if(!d){var t=$(this).closest(".list-item"),e=t.data("vid"),n=t.data("bid"),i=t.data("title");BDWM.confirm({text:"<span>当前操作不可撤销，是否确认删除投票</span><br><span>"+i+"</span>",callback:function(t){t&&(d=!0,a(n,e).done(function(t){d=!1,t.success?BDWM.reload():BDWM.alert({text:"操作失败>.<"})}).fail(function(){d=!1,BDWM.alert({text:"网络超时辣>.<"})}))}})}});var t=null;$('[data-action="open-vote"]').click(function(){$(this).hide(),$(".open-vote-body").show().find("select.cs-select").each(function(){BDWM.initSelect(this)}),null==t&&(t=s()?$('[data-role="vote-content"]'):$('[data-role="vote-content"]').bdwm_editor()[0])}),$('[data-role="vote-type"]').change(function(){var t=$(this).val();2==t?($('[data-role="vote-options"]').addClass("radio").closest(".row").show(),$('[data-role="vote-maxtickets"]').closest(".row").hide(),$('[data-role="vote-maxvalue"]').closest(".row").hide()):3==t?($('[data-role="vote-options"]').removeClass("radio").closest(".row").show(),$('[data-role="vote-maxtickets"]').closest(".row").show(),$('[data-role="vote-maxvalue"]').closest(".row").hide()):4==t?($('[data-role="vote-options"]').closest(".row").hide(),$('[data-role="vote-maxtickets"]').closest(".row").hide(),$('[data-role="vote-maxvalue"]').closest(".row").show()):($('[data-role="vote-options"]').closest(".row").hide(),$('[data-role="vote-maxtickets"]').closest(".row").hide(),$('[data-role="vote-maxvalue"]').closest(".row").hide())}),$('[data-action="add-option"]').click(function(){$('[data-role="vote-option"]').length>=32||($(this).before('<div class="input-wrapper"><input type="text" data-role="vote-option" maxlength="50"><a class="remove-option" data-action="remove-option"></a></div>'),$('[data-action="remove-option"]').unbind("click").click(function(){$(this).closest(".input-wrapper").remove()}))}),$('[data-action="remove-option"]').click(function(){$(this).closest(".input-wrapper").remove()}),$('[data-action="confirm-open-vote"]').click(function(){var e,a=$('[data-role="vote-title"]').val();e=s()?[$.extend(!0,{},BDWM.defaultStyle,{content:t.val()+"\n"})]:t.toStruct();var n=parseInt($('[data-role="vote-type"]').val()),i=parseInt($('[data-role="vote-day"]').val()),o=parseInt($('[data-role="vote-maxtickets"]').val()),r=parseInt($('[data-role="vote-maxvalue"]').val()),c=parseInt($("input[type='radio'][data-role='vote-publiclevel']:checked").val()),d=[];if(""==a)return BDWM.alert({text:"标题不可为空",timeout:2e3});if(s()&&""==t.val())return BDWM.alert({text:"描述不可为空",timeout:2e3});if(!s()&&""==t.getText())return BDWM.alert({text:"描述不可为空",timeout:2e3});if(isNaN(i)||i<1||i>100)return BDWM.alert({text:"投票天数不合法",timeout:2e3});(isNaN(c)||c<0||c>2)&&(c=0),$('[data-role="vote-option"]').each(function(){""!=$(this).val()&&d.push($(this).val())});var l={bid:$(".open-vote-body").data("bid"),title:a,desc:JSON.stringify(e),type:n,maxdays:i,publiclevel:c};if(1==n)d=["赞成  （是的）","不赞成（不是）","没意见（不清楚）"],l.items=d;else if(2==n){if(d.length<2)return BDWM.alert({text:"有效选项不足两项",timeout:2e3});l.items=d}else if(3==n){if(d.length<2)return BDWM.alert({text:"有效选项不足两项",timeout:2e3});if(isNaN(o)||o<1||d.length<o)return BDWM.alert({text:"最多投票数不合法",timeout:2e3});l.items=d,l.maxtickets=o}else if(4==n){if(isNaN(r)||r<0)return BDWM.alert({text:"最大数值不合法",timeout:2e3});l.maxvalue=r}l.items&&(l.items=JSON.stringify(l.items)),$.ajax({type:"post",url:"ajax/create_vote.php",dataType:"json",data:l,timeout:4e3}).done(function(t){t.success?BDWM.reload():BDWM.alert({text:"开启投票失败",timeout:2e3})}).fail(function(){BDWM.alert({text:"网络错误,请稍后再试",timeout:2e3})})}),$('[data-action="cancel-open-vote"]').click(function(){$(".open-vote-body").hide(),$('[data-action="open-vote"]').show()})}function s(){return ua&&"ie"==ua.browser.family.toLowerCase()}BDWM.init("#vote, #vote-opt",function(){t(),n(),i(),o(),r()}.bind(this));var c="ajax/operate_vote.php",d=!1}.call(this),function(){BDWM.init("#dialog-welcome",function(){if(!isShownWelcome&&login){var t=localStorage.getItem("welcome");if(!t||t!=(new Date).toDateString()){$("#dialog-welcome").bdwm_dialog().show();var e=function(){var t=$("#dialog-welcome");if(t.hasClass("huge")){var e=t.width(),a=t.height(),n=$("#welcome-image");a/e<=9/16?(n.width(e),n.height(e/16*9)):(n.height(a),n.width(a/9*16))}};e(),$("#dialog-welcome").on("resize",e),$('[data-action="show-welcome-request"]').click(function(){$("#dialog-welcome").bdwm_dialog().hide(),$("#dialog-welcome-request").bdwm_dialog().show()});var a=$("#welcome-image");"complete"==a.eq(0).get(0).readyState||a.eq(0).get(0).complete?(a.css({visibility:"",display:"none"}),a.fadeIn("normal",function(){$("#dialog-welcome .loading").hide()})):a.load(function(){a.css({visibility:"",display:"none"}),a.fadeIn("normal",function(){$("#dialog-welcome .loading").hide()})})}localStorage.setItem("welcome",(new Date).toDateString())}isShownWelcome=!0})}();